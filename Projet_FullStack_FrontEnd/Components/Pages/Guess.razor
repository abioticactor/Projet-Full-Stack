@page "/guess/{PartieId}/{DresseurPseudo}"
@using System.Net.Http.Json
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Guess> Logger
@inject NavigationManager NavigationManager
@inject Projet_FullStack_FrontEnd.Services.AuthService AuthService
@implements IDisposable

<RequireAuth>
<div class="guess-container">
    @if (isLoading)
    {
        <div class="loading">
            <p>Chargement...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            <span class="message-icon">‚ùå</span>
            <div>
                <p>Erreur : @errorMessage</p>
                <button class="btn-primary" @onclick="BackToMenu">Retour au menu</button>
            </div>
        </div>
    }
    else if (gameFinished)
    {
        <div class="game-finished">
            <span class="finish-icon">üéâ</span>
            <h2>Partie termin√©e !</h2>
            <p><strong>Score final :</strong> @currentScore points</p>
            <button class="btn-primary" @onclick="BackToMenu">Nouvelle partie</button>
        </div>
    }
    else
    {
        <div class="game-header">
            <h1>Devinez le Pok√©mon !</h1>
            <div class="session-info">
                <span class="session-code"><span class="info-icon">üéØ</span> Code : @sessionCode</span>
                @if (partie?.ModeSolo != true)
                {
                    <span class="players"><span class="info-icon">üë•</span> @player1Pseudo VS @player2Pseudo</span>
                }
                else
                {
                    <span class="players"><span class="info-icon">üë§</span> Mode Solo - @player1Pseudo</span>
                }
            </div>
            <div class="game-stats">
                <span class="score"><span class="stat-icon">‚≠ê</span> Score : @currentScore</span>
                <span class="attempts"><span class="stat-icon">üé≤</span> Tentatives : @attemptsUsed / 3</span>
                <span class="timer @(timeRemaining <= 10 ? "timer-warning" : "")">
                    <span class="stat-icon">‚è±Ô∏è</span> Temps : @timeRemaining.ToString("F1")s
                </span>
            </div>
        </div>

        <div class="game-content">
            <!-- Colonne gauche : Description + R√©ponse -->
            <div class="left-column">
                <!-- Description censur√©e -->
                <div class="description-section">
                    <h2>Description du Pok√©dex</h2>
                    <div class="censored-description">
                        @if (!string.IsNullOrEmpty(censoredDescription))
                        {
                            <p>@censoredDescription</p>
                        }
                        else
                        {
                            <p class="loading-text">Chargement de la description...</p>
                        }
                    </div>
                </div>

                <!-- Section de devinette -->
                <div class="guess-section">
                    <h3>Votre r√©ponse</h3>
                    <div class="search-container">
                        <input 
                            type="text" 
                            @bind="searchTerm" 
                            @bind:event="oninput"
                            @onfocus="ShowDropdown"
                            placeholder="Rechercher un Pok√©mon..."
                            class="input-field pokemon-search"
                            disabled="@isSubmitting" />
                        
                        @if (showDropdown && filteredPokemons.Any())
                        {
                            <div class="dropdown-list">
                                @foreach (var pokemon in filteredPokemons.Take(10))
                                {
                                    <div class="dropdown-item" @onclick="@(() => SelectPokemon(pokemon))">
                                        <span class="pokemon-number">#@pokemon.PokedexNumber</span>
                                        <span class="pokemon-name">@pokemon.NameFr</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(selectedPokemonName))
                    {
                        <div class="selected-pokemon">
                            <strong>Pok√©mon s√©lectionn√© :</strong> @selectedPokemonName
                        </div>
                    }

                    <button 
                        @onclick="SubmitGuess" 
                        disabled="@(string.IsNullOrEmpty(selectedPokemonName) || isSubmitting)"
                        class="btn-primary submit-button">
                        <span class="btn-icon">‚úì</span> @(isSubmitting ? "Envoi..." : "Valider la r√©ponse")
                    </button>

                    @if (!string.IsNullOrEmpty(guessResultMessage))
                    {
                        <div class="result-message @(lastGuessCorrect ? "correct" : "incorrect")">
                            @guessResultMessage
                        </div>
                    }
                </div>
            </div>

            <!-- Colonne droite : Indices -->
            <div class="right-column">
                <!-- Section des indices -->
                <div class="hints-section">
                <h3>Indices disponibles</h3>
                <p class="hints-info">Chaque indice co√ªte des points !</p>
                
                <div class="hints-grid">
                    <button 
                        @onclick="@(() => RequestHint("Type1"))" 
                        disabled="@(usedHints.Contains("Type1") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Type1") ? "revealed" : "")">
                        @if (usedHints.Contains("Type1") && revealedHints.ContainsKey("Type 1"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Type 1"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üî∑</span>
                            <span>Type 1</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Type2"))" 
                        disabled="@(usedHints.Contains("Type2") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Type2") ? "revealed" : "")">
                        @if (usedHints.Contains("Type2") && revealedHints.ContainsKey("Type 2"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Type 2"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üî∂</span>
                            <span>Type 2</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Generation"))" 
                        disabled="@(usedHints.Contains("Generation") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Generation") ? "revealed" : "")">
                        @if (usedHints.Contains("Generation") && revealedHints.ContainsKey("G√©n√©ration"))
                        {
                            <span class="revealed-hint-content">@revealedHints["G√©n√©ration"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üìÖ</span>
                            <span>G√©n√©ration</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Category"))" 
                        disabled="@(usedHints.Contains("Category") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Category") ? "revealed" : "")">
                        @if (usedHints.Contains("Category") && revealedHints.ContainsKey("Cat√©gorie"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Cat√©gorie"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üè∑Ô∏è</span>
                            <span>Cat√©gorie</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Stats"))" 
                        disabled="@(usedHints.Contains("Stats") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Stats") ? "revealed" : "")">
                        @if (usedHints.Contains("Stats") && revealedHints.ContainsKey("Statistiques"))
                        {
                            <span class="revealed-hint-content stats">@revealedHints["Statistiques"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üìä</span>
                            <span>Statistiques</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Height"))" 
                        disabled="@(usedHints.Contains("Height") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Height") ? "revealed" : "")">
                        @if (usedHints.Contains("Height") && revealedHints.ContainsKey("Taille"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Taille"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üìè</span>
                            <span>Taille</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Weight"))" 
                        disabled="@(usedHints.Contains("Weight") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Weight") ? "revealed" : "")">
                        @if (usedHints.Contains("Weight") && revealedHints.ContainsKey("Poids"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Poids"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">‚öñÔ∏è</span>
                            <span>Poids</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Abilities"))" 
                        disabled="@(usedHints.Contains("Abilities") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Abilities") ? "revealed" : "")">
                        @if (usedHints.Contains("Abilities") && revealedHints.ContainsKey("Talents"))
                        {
                            <span class="revealed-hint-content">@revealedHints["Talents"]</span>
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">‚ö°</span>
                            <span>Talents</span>
                        }
                    </button>

                    <button 
                        @onclick="@(() => RequestHint("Sprite"))" 
                        disabled="@(usedHints.Contains("Sprite") || isRequestingHint)"
                        class="hint-button @(usedHints.Contains("Sprite") ? "revealed" : "")">
                        @if (usedHints.Contains("Sprite") && revealedHints.ContainsKey("Silhouette"))
                        {
                            <img src="@revealedHints["Silhouette"]" alt="Silhouette" class="revealed-sprite-img" />
                            <span class="used-badge">‚úì</span>
                        }
                        else
                        {
                            <span class="hint-icon">üë§</span>
                            <span>Silhouette</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
    }
</div>

        @if (showSuccessModal && !string.IsNullOrEmpty(revealedPokemonSprite))
        {
            <div class="modal-overlay">
                <div class="success-modal">
                    <span class="modal-icon success-icon">üéâ</span>
                    <h4>Bravo ! C'√©tait bien :</h4>
                    <div class="pokemon-reveal">
                        <img src="@revealedPokemonSprite" alt="Pok√©mon trouv√©" class="revealed-sprite" />
                        <p class="pokemon-name-reveal">@selectedPokemonName</p>
                    </div>
                    <button @onclick="ProceedAfterSuccess" class="btn-primary next-button">
                        <span class="btn-icon">‚û°Ô∏è</span> @(isFinalPokemon ? "Terminer la partie" : "Passer au Pok√©mon suivant")
                    </button>
                </div>
            </div>
        }

        @if (showFailureModal && !string.IsNullOrEmpty(revealedPokemonSprite))
        {
            <div class="modal-overlay">
                <div class="failure-modal">
                    <span class="modal-icon failure-icon">@(isTimeout ? "‚è±Ô∏è" : "üòî")</span>
                    <h4>@(isTimeout ? "Temps √©coul√© ! C'√©tait :" : "Dommage ! C'√©tait :")</h4>
                    <div class="pokemon-reveal">
                        <img src="@revealedPokemonSprite" alt="Pok√©mon √† deviner" class="revealed-sprite" />
                        <p class="pokemon-name-reveal">@(allPokemons.FirstOrDefault(p => p.Id == currentPokemonId)?.NameFr ?? "Pok√©mon inconnu")</p>
                    </div>
                    <button @onclick="ProceedAfterFailure" class="btn-primary next-button">
                        <span class="btn-icon">‚û°Ô∏è</span> @(isFinalPokemon ? "Terminer la partie" : "Passer au Pok√©mon suivant")
                    </button>
                </div>
            </div>
        }

@code {
    [Parameter]
    public string PartieId { get; set; } = string.Empty;

    [Parameter]
    public string DresseurPseudo { get; set; } = string.Empty;

    // ID r√©el du dresseur (r√©cup√©r√© depuis AuthService)
    private string DresseurId => AuthService.CurrentUserId ?? "";

    // √âtats
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool isRequestingHint = false;
    private bool gameFinished = false;
    private bool showSuccessModal = false;
    private bool showFailureModal = false;
    private bool isFinalPokemon = false;
    private string? errorMessage;

    // Donn√©es du jeu
    private string censoredDescription = string.Empty;
    private string currentPokemonId = string.Empty;
    private string currentPokemonSprite = string.Empty;
    private int currentScore = 0;
    private int attemptsUsed = 0;
    private List<string> usedHints = new();
    private Dictionary<string, string> revealedHints = new();
    
    // Informations de session
    private PartieDto? partie;
    private string sessionCode = string.Empty;
    private string player1Pseudo = string.Empty;
    private string player2Pseudo = string.Empty;

    // Recherche et s√©lection
    private string searchTerm = string.Empty;
    private string selectedPokemonName = string.Empty;
    private bool showDropdown = false;
    private List<PokemonDto> allPokemons = new();

    // R√©sultat de la devinette
    private string guessResultMessage = string.Empty;
    private bool lastGuessCorrect = false;
    private string revealedPokemonSprite = string.Empty;
    
    // Timer
    private double timeRemaining = 60.0;
    private System.Threading.Timer? timer;
    private bool isTimeout = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadGameData();
        await LoadAllPokemons();
        StartTimer();
    }
    
    public void Dispose()
    {
        timer?.Dispose();
    }

    private void BackToMenu()
    {
        NavigationManager.NavigateTo("/partie");
    }

    private void ShowDropdown()
    {
        showDropdown = true;
    }

    private async Task LoadGameData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var partieResponse = await Http.GetAsync($"api/partie/{PartieId}");
            partieResponse.EnsureSuccessStatusCode();
            partie = await partieResponse.Content.ReadFromJsonAsync<PartieDto>();

            if (partie == null)
            {
                errorMessage = "Impossible de charger les donn√©es de la partie";
                return;
            }

            currentPokemonId = partie.Dresseur1Id == DresseurId 
                ? partie.PokemonsToGuessJ1?.ElementAtOrDefault(partie.CurrentIndexJ1)?.Id ?? string.Empty
                : partie.PokemonsToGuessJ2?.ElementAtOrDefault(partie.CurrentIndexJ2)?.Id ?? string.Empty;

            if (string.IsNullOrEmpty(currentPokemonId))
            {
                errorMessage = "Aucun Pok√©mon √† deviner";
                return;
            }

            currentScore = partie.Dresseur1Id == DresseurId ? partie.ScoreJ1 : partie.ScoreJ2;
            attemptsUsed = partie.Dresseur1Id == DresseurId ? partie.AttemptsUsedJ1 : partie.AttemptsUsedJ2;
            usedHints = partie.Dresseur1Id == DresseurId ? partie.UsedHintsJ1 : partie.UsedHintsJ2;
            
            // Charger les infos de session
            sessionCode = partie.CodeSession ?? "N/A";
            await LoadPlayersPseudos(partie.Dresseur1Id, partie.Dresseur2Id);

            await LoadCensoredDescription();
            await LoadPokemonSprite();
            await LoadRevealedHints();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des donn√©es");
            errorMessage = $"Erreur : {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCensoredDescription()
    {
        try
        {
            var response = await Http.GetAsync($"api/pokemon/{currentPokemonId}/censored-description");
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<CensoredDescriptionDto>();
            censoredDescription = result?.Description ?? "Description non disponible";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement de la description");
            censoredDescription = "Erreur lors du chargement de la description";
        }
    }

    private async Task LoadPokemonSprite()
    {
        try
        {
            var response = await Http.GetAsync($"api/pokemon/{currentPokemonId}/hints");
            response.EnsureSuccessStatusCode();
            var hints = await response.Content.ReadFromJsonAsync<PokemonHintsDto>();
            
            if (hints?.Sprites != null)
            {
                currentPokemonSprite = hints.Sprites.FrontDefault ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement du sprite");
        }
    }

    private async Task LoadAllPokemons()
    {
        try
        {
            var response = await Http.GetAsync("api/pokemon");
            response.EnsureSuccessStatusCode();
            allPokemons = await response.Content.ReadFromJsonAsync<List<PokemonDto>>() ?? new();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des Pok√©mon");
        }
    }

    private async Task LoadPlayersPseudos(string? dresseur1Id, string? dresseur2Id)
    {
        try
        {
            // Pour le joueur connect√©, utiliser le pseudo du token
            string currentUserPseudo = AuthService.CurrentPseudo ?? "N/A";
            
            // D√©terminer qui est le joueur 1 et le joueur 2
            bool isPlayer1 = dresseur1Id == DresseurId;
            
            if (isPlayer1)
            {
                // Le joueur connect√© est le joueur 1
                player1Pseudo = currentUserPseudo;
                
                // Charger le pseudo du joueur 2 via l'API (sauf en mode solo)
                if (!string.IsNullOrEmpty(dresseur2Id) && partie?.ModeSolo != true)
                {
                    var response2 = await Http.GetAsync($"api/dresseurs/{dresseur2Id}");
                    if (response2.IsSuccessStatusCode)
                    {
                        var dresseur2 = await response2.Content.ReadFromJsonAsync<DresseurDto>();
                        player2Pseudo = dresseur2?.Pseudo ?? "N/A";
                    }
                    else
                    {
                        player2Pseudo = "N/A";
                    }
                }
                else
                {
                    player2Pseudo = partie?.ModeSolo == true ? "Mode Solo" : "N/A";
                }
            }
            else
            {
                // Le joueur connect√© est le joueur 2
                player2Pseudo = currentUserPseudo;
                
                // Charger le pseudo du joueur 1 via l'API
                if (!string.IsNullOrEmpty(dresseur1Id))
                {
                    var response1 = await Http.GetAsync($"api/dresseurs/{dresseur1Id}");
                    if (response1.IsSuccessStatusCode)
                    {
                        var dresseur1 = await response1.Content.ReadFromJsonAsync<DresseurDto>();
                        player1Pseudo = dresseur1?.Pseudo ?? "N/A";
                    }
                    else
                    {
                        player1Pseudo = "N/A";
                    }
                }
                else
                {
                    player1Pseudo = "N/A";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des pseudos");
            player1Pseudo = "N/A";
            player2Pseudo = "N/A";
        }
    }

    private async Task LoadRevealedHints()
    {
        try
        {
            Logger.LogInformation($"Chargement des indices pour le Pok√©mon {currentPokemonId}");
            Logger.LogInformation($"Indices utilis√©s: {string.Join(", ", usedHints)}");
            
            var response = await Http.GetAsync($"api/pokemon/{currentPokemonId}/hints");
            response.EnsureSuccessStatusCode();
            var hints = await response.Content.ReadFromJsonAsync<PokemonHintsDto>();

            if (hints != null)
            {
                revealedHints.Clear();

                if (hints.Sprites != null)
                {
                    var spriteUrl = hints.Sprites.FrontDefault ?? string.Empty;
                    if (!string.IsNullOrEmpty(spriteUrl))
                    {
                        currentPokemonSprite = spriteUrl;
                    }
                }

                if (usedHints.Contains("Sprite") && !string.IsNullOrEmpty(currentPokemonSprite))
                {
                    revealedHints["Silhouette"] = currentPokemonSprite;
                    Logger.LogInformation("Indice Silhouette ajout√©");
                }
                
                if (usedHints.Contains("Type1") && hints.Types != null && hints.Types.Any())
                {
                    var type1 = hints.Types.FirstOrDefault(t => t.Slot == 1);
                    if (type1 != null)
                    {
                        revealedHints["Type 1"] = type1.Name;
                        Logger.LogInformation($"Indice Type 1 ajout√©: {type1.Name}");
                    }
                }
                if (usedHints.Contains("Type2") && hints.Types != null)
                {
                    var type2 = hints.Types.FirstOrDefault(t => t.Slot == 2);
                    if (type2 != null)
                    {
                        revealedHints["Type 2"] = type2.Name;
                        Logger.LogInformation($"Indice Type 2 ajout√©: {type2.Name}");
                    }
                    else
                    {
                        revealedHints["Type 2"] = "Pas de second type";
                        Logger.LogInformation("Indice Type 2 ajout√©: Pas de second type");
                    }
                }
                if (usedHints.Contains("Generation") && hints.Generation != null)
                {
                    revealedHints["G√©n√©ration"] = hints.Generation.NameFr;
                    Logger.LogInformation($"Indice G√©n√©ration ajout√©: {hints.Generation.NameFr}");
                }
                if (usedHints.Contains("Category") && !string.IsNullOrEmpty(hints.Category))
                {
                    revealedHints["Cat√©gorie"] = hints.Category;
                    Logger.LogInformation($"Indice Cat√©gorie ajout√©: {hints.Category}");
                }
                if (usedHints.Contains("Stats") && hints.Stats != null)
                {
                    var statsText = $"PV: {hints.Stats.PV.Value}, Att: {hints.Stats.Attaque.Value}, Def: {hints.Stats.Defense.Value}, Att Sp√©: {hints.Stats.AttaqueSpe.Value}, Def Sp√©: {hints.Stats.DefenseSpe.Value}, Vitesse: {hints.Stats.Vitesse.Value}";
                    revealedHints["Statistiques"] = statsText;
                    Logger.LogInformation($"Indice Stats ajout√©: {statsText}");
                }
                if (usedHints.Contains("Height") && hints.Physical != null)
                {
                    var heightText = $"{hints.Physical.HeightM}m";
                    revealedHints["Taille"] = heightText;
                    Logger.LogInformation($"Indice Taille ajout√©: {heightText}");
                }
                if (usedHints.Contains("Weight") && hints.Physical != null)
                {
                    var weightText = $"{hints.Physical.WeightKg}kg";
                    revealedHints["Poids"] = weightText;
                    Logger.LogInformation($"Indice Poids ajout√©: {weightText}");
                }
                if (usedHints.Contains("Abilities") && hints.Abilities != null && hints.Abilities.Any())
                {
                    var abilitiesText = string.Join(", ", hints.Abilities.Select(a => a.Name));
                    revealedHints["Talents"] = abilitiesText;
                    Logger.LogInformation($"Indice Talents ajout√©: {abilitiesText}");
                }
                
                Logger.LogInformation($"Total indices r√©v√©l√©s: {revealedHints.Count}");
            }
            else
            {
                Logger.LogWarning("Les hints re√ßus de l'API sont null");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des indices");
        }
    }

    private void SelectPokemon(PokemonDto pokemon)
    {
        selectedPokemonName = pokemon.NameFr;
        searchTerm = pokemon.NameFr;
        showDropdown = false;
    }

    private async Task SubmitGuess()
    {
        if (string.IsNullOrEmpty(selectedPokemonName))
            return;

        isSubmitting = true;
        guessResultMessage = string.Empty;

        try
        {
            var request = new SubmitGuessRequest
            {
                DresseurId = DresseurId,
                PokemonName = selectedPokemonName
            };

            var response = await Http.PostAsJsonAsync($"api/partie/{PartieId}/guess", request);
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<GuessResultDto>();

            if (result != null)
            {
                lastGuessCorrect = result.IsCorrect;
                guessResultMessage = result.Message;
                currentScore = result.PointsEarned;

                if (result.IsCorrect)
                {
                    timer?.Dispose(); // Arr√™ter le timer
                    revealedPokemonSprite = currentPokemonSprite;
                    isFinalPokemon = result.IsGameFinished;
                    showSuccessModal = true;
                }
                else if (result.IsTimeout)
                {
                    timer?.Dispose(); // Arr√™ter le timer
                    revealedPokemonSprite = currentPokemonSprite;
                    isFinalPokemon = result.IsGameFinished;
                    showFailureModal = true;
                }
                else
                {
                    attemptsUsed++;
                    
                    if (result.IsTurnFinished)
                    {
                        timer?.Dispose(); // Arr√™ter le timer
                        // Afficher le modal d'√©chec au lieu de passer automatiquement
                        revealedPokemonSprite = currentPokemonSprite;
                        isFinalPokemon = result.IsGameFinished;
                        showFailureModal = true;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de l'envoi de la r√©ponse");
            guessResultMessage = "Erreur lors de l'envoi de la r√©ponse";
            lastGuessCorrect = false;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task ProceedAfterSuccess()
    {
        showSuccessModal = false;

        if (isFinalPokemon)
        {
            NavigationManager.NavigateTo($"/resultats/{PartieId}");
        }
        else
        {
            // R√©initialiser le timer c√¥t√© serveur
            await ResetTimerOnServer();
            
            await LoadGameData();
            ResetGuessState();
            StartTimer(); // Red√©marrer le timer pour le prochain Pok√©mon
        }

        lastGuessCorrect = false;
        guessResultMessage = string.Empty;
        isFinalPokemon = false;
    }

    private async Task ProceedAfterFailure()
    {
        showFailureModal = false;
        isTimeout = false;

        if (isFinalPokemon)
        {
            NavigationManager.NavigateTo($"/resultats/{PartieId}");
        }
        else
        {
            // R√©initialiser le timer c√¥t√© serveur
            await ResetTimerOnServer();
            
            await LoadGameData();
            ResetGuessState();
            StartTimer(); // Red√©marrer le timer pour le prochain Pok√©mon
        }

        lastGuessCorrect = false;
        guessResultMessage = string.Empty;
        isFinalPokemon = false;
    }
    
    private async Task ResetTimerOnServer()
    {
        try
        {
            var request = new ResetTimerRequest
            {
                DresseurId = DresseurId
            };
            
            await Http.PostAsJsonAsync($"api/partie/{PartieId}/timer/reset", request);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la r√©initialisation du timer");
        }
    }

    private async Task RequestHint(string hintType)
    {
        if (usedHints.Contains(hintType))
            return;

        isRequestingHint = true;

        try
        {
            var request = new UseHintRequest
            {
                DresseurId = DresseurId,
                HintType = hintType
            };

            var response = await Http.PostAsJsonAsync($"api/partie/{PartieId}/hint", request);
            response.EnsureSuccessStatusCode();

            // Ajouter l'indice √† la liste locale
            if (!usedHints.Contains(hintType))
            {
                usedHints.Add(hintType);
            }

            // Charger et afficher l'indice r√©v√©l√©
            await LoadRevealedHints();
            
            // Forcer le rafra√Æchissement de l'interface
            StateHasChanged();
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, $"Erreur lors de la demande d'indice '{hintType}'");
            errorMessage = $"Erreur lors de la demande d'indice '{hintType}'. Assurez-vous que le backend est √† jour et red√©marr√©.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Erreur inattendue lors de la demande d'indice '{hintType}'");
            errorMessage = $"Erreur inattendue: {ex.Message}";
        }
        finally
        {
            isRequestingHint = false;
        }
    }

    private void ResetGuessState()
    {
        searchTerm = string.Empty;
        selectedPokemonName = string.Empty;
        guessResultMessage = string.Empty;
        showDropdown = false;
    }
    
    private void StartTimer()
    {
        timer?.Dispose();
        timer = new System.Threading.Timer(async _ => await UpdateTimer(), null, TimeSpan.Zero, TimeSpan.FromMilliseconds(100));
    }

    private async Task UpdateTimer()
    {
        try
        {
            var response = await Http.GetAsync($"api/partie/{PartieId}/timer/{DresseurId}");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TimerResponse>();
                if (result != null)
                {
                    timeRemaining = result.TimeRemaining;
                    
                    if (timeRemaining <= 0 && !isTimeout)
                    {
                        isTimeout = true;
                        await InvokeAsync(async () =>
                        {
                            await HandleTimeout();
                        });
                    }
                    
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la mise √† jour du timer");
        }
    }

    private async Task HandleTimeout()
    {
        timer?.Dispose();
        
        try
        {
            // Afficher directement le popup d'√©chec avec les donn√©es actuelles
            revealedPokemonSprite = currentPokemonSprite;
            
            // Soumettre au backend pour enregistrer l'√©chec (cela va incr√©menter l'index)
            var request = new SubmitGuessRequest
            {
                DresseurId = DresseurId,
                PokemonName = "__TIMEOUT__" // Marqueur sp√©cial pour le timeout
            };

            var response = await Http.PostAsJsonAsync($"api/partie/{PartieId}/guess", request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<GuessResultDto>();
                if (result != null)
                {
                    isFinalPokemon = result.IsGameFinished;
                }
            }
            
            showFailureModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la gestion du timeout");
        }
    }

    private List<PokemonDto> filteredPokemons
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
                return new List<PokemonDto>();

            return allPokemons
                .Where(p => p.NameFr.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                           p.PokedexNumber.ToString().Contains(searchTerm))
                .OrderBy(p => p.PokedexNumber)
                .ToList();
        }
    }

    public class PartieDto
    {
        public string? Id { get; set; }
        public string? CodeSession { get; set; }
        public string? Statut { get; set; }
        public string? Dresseur1Id { get; set; }
        public string? Dresseur2Id { get; set; }
        public bool ModeSolo { get; set; } = false;
        public List<PokemonSimpleDto>? PokemonsToGuessJ1 { get; set; }
        public List<PokemonSimpleDto>? PokemonsToGuessJ2 { get; set; }
        public int CurrentIndexJ1 { get; set; }
        public int CurrentIndexJ2 { get; set; }
        public int ScoreJ1 { get; set; }
        public int ScoreJ2 { get; set; }
        public int AttemptsUsedJ1 { get; set; }
        public int AttemptsUsedJ2 { get; set; }
        public List<string> UsedHintsJ1 { get; set; } = new();
        public List<string> UsedHintsJ2 { get; set; } = new();
    }

    public class PokemonSimpleDto
    {
        public string? Id { get; set; }
    }

    public class PokemonDto
    {
        public string Id { get; set; } = string.Empty;
        public string NameFr { get; set; } = string.Empty;
        public int PokedexNumber { get; set; }
    }

    public class CensoredDescriptionDto
    {
        public string Description { get; set; } = string.Empty;
    }

    public class PokemonHintsDto
    {
        public string? Category { get; set; }
        public GenerationDto? Generation { get; set; }
        public List<TypeDto>? Types { get; set; }
        public StatsDto? Stats { get; set; }
        public PhysicalDto? Physical { get; set; }
        public List<AbilityDto>? Abilities { get; set; }
        public SpritesDto? Sprites { get; set; }
    }

    public class GenerationDto
    {
        public string NameFr { get; set; } = string.Empty;
        public string NameEn { get; set; } = string.Empty;
    }

    public class TypeDto
    {
        public string Name { get; set; } = string.Empty;
        public string NameEn { get; set; } = string.Empty;
        public int Slot { get; set; }
    }

    public class StatsDto
    {
        public StatDto PV { get; set; } = new();
        public StatDto Attaque { get; set; } = new();
        public StatDto Defense { get; set; } = new();
        public StatDto AttaqueSpe { get; set; } = new();
        public StatDto DefenseSpe { get; set; } = new();
        public StatDto Vitesse { get; set; } = new();
    }

    public class StatDto
    {
        public int Value { get; set; }
        public string NameEn { get; set; } = string.Empty;
    }

    public class PhysicalDto
    {
        public double HeightM { get; set; }
        public double WeightKg { get; set; }
    }

    public class AbilityDto
    {
        public string Name { get; set; } = string.Empty;
        public string NameEn { get; set; } = string.Empty;
        public bool IsHidden { get; set; }
        public int Slot { get; set; }
    }

    public class SpritesDto
    {
        public string FrontDefault { get; set; } = string.Empty;
        public string? FrontShiny { get; set; }
        public string? BackDefault { get; set; }
        public string? BackShiny { get; set; }
    }

    public class SubmitGuessRequest
    {
        public string DresseurId { get; set; } = string.Empty;
        public string PokemonName { get; set; } = string.Empty;
    }

    public class UseHintRequest
    {
        public string DresseurId { get; set; } = string.Empty;
        public string HintType { get; set; } = string.Empty;
    }

    public class GuessResultDto
    {
        public bool IsCorrect { get; set; }
        public bool IsTurnFinished { get; set; }
        public bool IsGameFinished { get; set; }
        public bool IsTimeout { get; set; }
        public string Message { get; set; } = string.Empty;
        public int PointsEarned { get; set; }
    }

    public class DresseurDto
    {
        public string? Id { get; set; }
        public string? Pseudo { get; set; }
    }
    
    public class TimerResponse
    {
        public double TimeRemaining { get; set; }
    }
    
    public class ResetTimerRequest
    {
        public string DresseurId { get; set; } = string.Empty;
    }
}

<style>
    /* Design tokens - Pok√©dex Gen 1 moderne/minimaliste */
    :root {
        --color-red: #E53935;
        --color-blue: #1E88E5;
        --color-bg: #F7F9FC;
        --color-white: #FFFFFF;
        --color-border: #D9E1EC;
        --color-text: #0F172A;
        --color-text-muted: #546E7A;
        --shadow-sm: 0 4px 12px rgba(15, 23, 42, 0.06);
        --radius-md: 12px;
        --space-xs: 8px;
        --space-sm: 12px;
        --space-md: 16px;
        --space-lg: 24px;
    }

    .guess-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-lg);
        color: var(--color-text);
    }

    .loading, .error-message, .game-finished {
        text-align: center;
        padding: 3rem;
        background: var(--color-white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
    }
    
    .message-icon, .finish-icon {
        font-size: 3rem;
        filter: grayscale(100%);
        opacity: 0.7;
        display: block;
        margin-bottom: var(--space-md);
    }

    .error-message {
        border: 2px solid #D32F2F;
    }
    
    .error-message p {
        color: #D32F2F;
        margin-bottom: var(--space-md);
        font-weight: 500;
    }

    .game-finished h2 {
        color: var(--color-text);
        margin-bottom: var(--space-md);
        font-weight: 600;
    }

    .game-header {
        text-align: center;
        margin-bottom: 2rem;
        background: var(--color-white);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
    }

    .game-header h1 {
        font-size: 2rem;
        margin-bottom: var(--space-md);
        color: var(--color-text);
        font-weight: 700;
    }

    .session-info {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        font-size: 0.95rem;
        color: var(--color-text-muted);
        margin-bottom: var(--space-md);
        flex-wrap: wrap;
    }
    
    .info-icon, .stat-icon {
        filter: grayscale(100%);
        opacity: 0.6;
        margin-right: 4px;
    }

    .session-info .session-code {
        color: var(--color-text-muted);
    }

    .session-info .players {
        color: var(--color-text);
        font-weight: 500;
    }

    .game-stats {
        display: flex;
        gap: 2rem;
        justify-content: center;
        font-size: 1.1rem;
        flex-wrap: wrap;
    }

    .game-stats .score {
        color: var(--color-blue);
        font-weight: 600;
    }

    .game-stats .attempts {
        color: #ffa500;
        font-weight: 600;
    }
    
    .game-stats .timer {
        color: #2E7D32;
        font-weight: 600;
        transition: color 0.3s ease;
    }
    
    .game-stats .timer.timer-warning {
        color: var(--color-red);
        animation: pulse 1s infinite;
    }
    
    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    .game-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
    }

    .left-column {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
    }

    .right-column {
        display: flex;
        flex-direction: column;
    }

    .description-section,
    .guess-section,
    .hints-section {
        background: var(--color-white);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-sm);
    }

    .hints-section {
        height: 100%;
    }

    .description-section h2,
    .guess-section h3,
    .hints-section h3 {
        margin-top: 0;
        color: var(--color-text);
        font-weight: 600;
        margin-bottom: var(--space-md);
    }

    .censored-description {
        background: rgba(30, 136, 229, 0.05);
        padding: var(--space-md);
        border-radius: var(--radius-md);
        font-size: 1.05rem;
        line-height: 1.6;
        border-left: 4px solid var(--color-blue);
        color: var(--color-text);
    }

    .loading-text {
        color: var(--color-text-muted);
        font-style: italic;
    }

    .search-container {
        position: relative;
        margin-bottom: var(--space-md);
    }
    
    .input-field {
        padding: 0.75rem;
        width: 100%;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        background: var(--color-white);
        color: var(--color-text);
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        height: 44px;
    }
    
    .input-field:focus {
        outline: none;
        border-color: var(--color-blue);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    
    .input-field:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pokemon-search {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .dropdown-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: var(--color-white);
        border: 2px solid var(--color-blue);
        border-radius: 10px;
        margin-top: 0.5rem;
        z-index: 1000;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.15);
    }

    .dropdown-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        gap: 1rem;
        align-items: center;
        border-bottom: 1px solid var(--color-border);
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: rgba(30, 136, 229, 0.1);
    }

    .pokemon-number {
        color: var(--color-text-muted);
        font-size: 0.9rem;
        min-width: 50px;
    }

    .pokemon-name {
        font-weight: 500;
        color: var(--color-text);
    }

    .selected-pokemon {
        padding: 0.75rem;
        background: rgba(30, 136, 229, 0.1);
        border-radius: 10px;
        margin-bottom: var(--space-md);
        color: var(--color-blue);
        border: 1px solid rgba(30, 136, 229, 0.2);
        font-weight: 500;
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: var(--color-blue);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
        justify-content: center;
    }
    
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-icon {
        filter: grayscale(100%);
        opacity: 0.8;
    }

    .submit-button {
        width: 100%;
        height: 48px;
        font-size: 1.05rem;
    }

    .result-message {
        margin-top: var(--space-md);
        padding: var(--space-md);
        border-radius: 10px;
        font-weight: 500;
        text-align: center;
    }

    .result-message.correct {
        background: rgba(46, 125, 50, 0.1);
        color: #2E7D32;
        border: 1px solid rgba(46, 125, 50, 0.3);
    }

    .result-message.incorrect {
        background: rgba(211, 47, 47, 0.1);
        color: #D32F2F;
        border: 1px solid rgba(211, 47, 47, 0.3);
    }

    .hints-info {
        color: #ffa500;
        font-size: 0.95rem;
        margin-bottom: var(--space-md);
        font-weight: 500;
    }

    .hints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .hint-button {
        position: relative;
        padding: var(--space-md);
        background: var(--color-white);
        border: 2px solid var(--color-border);
        border-radius: 10px;
        color: var(--color-text);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--space-xs);
        font-weight: 500;
        min-height: 100px;
    }

    .hint-button:hover:not(:disabled) {
        background: rgba(30, 136, 229, 0.05);
        border-color: var(--color-blue);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .hint-button:disabled {
        cursor: not-allowed;
        transform: none;
    }

    .hint-button.revealed {
        background: rgba(30, 136, 229, 0.1);
        border-color: var(--color-blue);
    }

    .revealed-hint-content {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-blue);
        text-align: center;
        line-height: 1.4;
        padding: 0 var(--space-xs);
    }

    .revealed-hint-content.stats {
        font-size: 0.75rem;
        line-height: 1.3;
        white-space: pre-line;
    }

    .revealed-sprite-img {
        max-width: 90%;
        height: auto;
        image-rendering: pixelated;
        filter: brightness(0);
    }

    .hint-icon {
        font-size: 1.5rem;
        filter: grayscale(100%);
        opacity: 0.7;
    }

    .used-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: #2E7D32;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    .success-reveal {
        margin-top: var(--space-xl);
        padding: var(--space-xl);
        background: rgba(46, 125, 50, 0.1);
        border: 2px solid #2E7D32;
        border-radius: var(--radius-lg);
        text-align: center;
        animation: fadeInScale 0.5s ease-out;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(4px);
    }

    .success-modal {
        background: var(--color-white);
        border: 2px solid #2E7D32;
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        max-width: 420px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: fadeInScale 0.3s ease-out;
    }

    .failure-modal {
        background: var(--color-white);
        border: 2px solid var(--color-red);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        max-width: 420px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: fadeInScale 0.3s ease-out;
    }

    .failure-modal h4 {
        color: var(--color-red);
    }

    .revealed-sprite {
        max-width: 300px;
        height: auto;
        margin: var(--space-md) auto;
        display: block;
        image-rendering: pixelated;
        animation: spriteReveal 0.8s ease-out;
    }

    .next-button {
        margin-top: var(--space-lg);
        padding: var(--space-md) var(--space-lg);
        font-size: 1rem;
        font-weight: 600;
        background: var(--color-blue);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        min-height: 44px;
    }

    .next-button:hover {
        background: #1976D2;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .next-button:active {
        transform: translateY(0);
    }

    .sprite-hint {
        max-width: 200px;
        height: auto;
        display: block;
        margin: var(--space-sm) 0;
        image-rendering: pixelated;
    }

    @@keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @@keyframes spriteReveal {
        from {
            opacity: 0;
            filter: brightness(0);
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            filter: brightness(1);
            transform: scale(1);
        }
    }

    button {
        font-family: inherit;
    }

    /* Responsive : mobile en 1 colonne */
    @@media (max-width: 768px) {
        .game-content {
            grid-template-columns: 1fr;
        }

        .guess-container {
            padding: var(--space-md);
        }

        .game-header h1 {
            font-size: 1.5rem;
        }

        .game-stats {
            gap: 1rem;
        }
    }
</style>
</RequireAuth>
