@page "/pokedex"
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using Microsoft.JSInterop
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Projet_FullStack_FrontEnd.Components.Pages.Pokedex> Logger
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<RequireAuth>
<div class="hero-content">
    <div class="hero-title">Pokédex</div>

    @if (isLoading)
    {
        <p><em>Chargement des pokémons…</em></p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger">Erreur : @errorMessage</p>
    }
    else if (pokemons is null || pokemons.Count == 0)
    {
        <p><em>Aucun pokémon disponible.</em></p>
    }
    else
    {
        <div class="pokedex-grid">
            @foreach (var pokemon in pokemons)
            {
                <div class="pokemon-card" @onclick="() => ShowDetails(pokemon?.numericId)" role="button" tabindex="0">
                    <div class="sprite-wrap">
                        <img src="@(pokemon?.sprites?.frontDefault ?? string.Empty)" alt="@(pokemon?.nameFr ?? string.Empty)" />
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">#@((pokemon?.numericId).GetValueOrDefault().ToString("D3")) - @(pokemon?.nameFr ?? "—")</h3>
                        <div class="types">
                            @foreach (var type in (pokemon?.types ?? Array.Empty<TypeEntry>()))
                            {
                                var display = type?.name ?? type?.nameFr ?? type?.name_fr ?? type?.nameEn ?? type?.name_en ?? string.Empty;
                                var cssRaw = type?.nameEn ?? type?.name_en ?? type?.name ?? display ?? string.Empty;
                                var css = (cssRaw ?? string.Empty).ToLowerInvariant().Replace(' ', '-').Replace('é','e').Replace('è','e');
                                <span class="type @css">@display</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
        
        @if (isLoadingMore)
        {
            <div class="loading-more">
                <p><em>Chargement de plus de pokémons…</em></p>
            </div>
        }
        
        @if (!hasMoreData && pokemons.Count > 0)
        {
            <div class="end-message">
                <p>Tous les pokémons ont été chargés !</p>
            </div>
        }
    }
</div>

@code {
    private List<Pokemon> pokemons = new();
    private bool isLoading = true;
    private bool isLoadingMore = false;
    private string? errorMessage;
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages = 0;
    private bool hasMoreData = true;
    private ElementReference scrollContainer;

    protected override async Task OnInitializedAsync()
    {
        await LoadPokemons();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initInfiniteScroll", DotNetObjectReference.Create(this));
        }
    }

    private async Task LoadPokemons()
    {
        if (isLoadingMore || !hasMoreData) return;

        if (currentPage == 1)
            isLoading = true;
        else
            isLoadingMore = true;

        errorMessage = null;
        try
        {
            var response = await Http.GetFromJsonAsync<PaginatedResponse>($"api/pokemon?page={currentPage}&pageSize={pageSize}");
            
            if (response == null || response.items == null)
            {
                errorMessage = "Aucune donnée reçue du serveur.";
                hasMoreData = false;
            }
            else
            {
                pokemons.AddRange(response.items);
                totalPages = response.totalPages;
                hasMoreData = currentPage < totalPages;
                currentPage++;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la récupération des pokémons");
            errorMessage = ex.Message;
            hasMoreData = false;
        }
        finally
        {
            isLoading = false;
            isLoadingMore = false;
        }
    }

    [JSInvokable]
    public async Task LoadMorePokemons()
    {
        await LoadPokemons();
        StateHasChanged();
    }

    void ShowDetails(int? id)
    {
        if (id.HasValue)
        {
            NavigationManager.NavigateTo($"/pokemon/{id.Value}");
        }
    }

    private class Pokemon
    {
        public string? id { get; set; }
        public int? numericId { get; set; }
        public string? nameFr { get; set; }
        public Sprites? sprites { get; set; }
        public TypeEntry[]? types { get; set; }
        public string? description { get; set; }
    }

    private class PaginatedResponse
    {
        public List<Pokemon>? items { get; set; }
        public int page { get; set; }
        public int pageSize { get; set; }
        public int totalCount { get; set; }
        public int totalPages { get; set; }
    }

    private class Sprites
    {
        public string? frontDefault { get; set; }
        public string? frontShiny { get; set; }
    }

    private class TypeEntry
    {
        [JsonPropertyName("name")]
        public string? name { get; set; }

        [JsonPropertyName("nameEn")]
        public string? nameEn { get; set; }

        [JsonPropertyName("name_en")]
        public string? name_en { get; set; }

        [JsonPropertyName("nameFr")]
        public string? nameFr { get; set; }

        [JsonPropertyName("name_fr")]
        public string? name_fr { get; set; }

        public int slot { get; set; }
    }

    public void Dispose()
    {
        // Nettoyage si nécessaire
    }
}

<style>
/* Pokedex page styling inspired by Home */
.hero-content { max-width: 1100px; margin: 0 auto; padding: 1.25rem; color: #fff; }
.hero-title { font-size: 1.6rem; font-weight: 600; margin-bottom: 0.75rem; }

.pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; padding: 0.75rem; }

.pokemon-card { background: rgba(255,255,255,0.03); border-radius: 16px; overflow: hidden; cursor: pointer; transition: transform 0.28s cubic-bezier(.2,.8,.2,1), box-shadow 0.28s; border: 1px solid rgba(255,255,255,0.04); box-shadow: 0 6px 14px rgba(0,0,0,0.18); display:flex; flex-direction:column; align-items:center; padding:1rem; }
.pokemon-card:focus, .pokemon-card:hover { transform: translateY(-8px); box-shadow: 0 18px 36px rgba(0,0,0,0.26); }

.sprite-wrap { width:120px; height:120px; display:flex; align-items:center; justify-content:center; border-radius: 999px; background: rgba(255,255,255,0.03); margin-bottom:0.6rem; }
.sprite-wrap img { width:96px; height:96px; image-rendering: pixelated; }

.card-body { text-align:center; width:100%; }
.card-title { font-size:1.05rem; margin:0; color:#000000; }

.types { display:flex; gap:0.5rem; justify-content:center; margin-top:0.5rem; flex-wrap:wrap; }
.type { padding:0.25rem 0.65rem; border-radius:999px; font-size:0.85rem; color:white; box-shadow: inset 0 -2px rgba(0,0,0,0.12); }

.loading-more, .end-message { text-align: center; padding: 2rem 1rem; color: #fff; font-size: 1.1rem; }
.end-message { color: #4CAF50; font-weight: 500; }

/* Types colors (kept from previous file) */
.normal { background-color: #A8A878; }
.fire { background-color: #F08030; }
.water { background-color: #6890F0; }
.electric { background-color: #F8D030; color:#222; }
.grass { background-color: #78C850; }
.ice { background-color: #98D8D8; color:#222; }
.fighting { background-color: #C03028; }
.poison { background-color: #A040A0; }
.ground { background-color: #E0C068; color:#222; }
.flying { background-color: #A890F0; }
.psychic { background-color: #F85888; }
.bug { background-color: #A8B820; color:#222; }
.rock { background-color: #B8A038; }
.ghost { background-color: #705898; }
.dragon { background-color: #7038F8; }
.dark { background-color: #705848; }
.steel { background-color: #B8B8D0; color:#222; }
.fairy { background-color: #EE99AC; color:#222; }

@@media (max-width: 768px) { .pokedex-grid { grid-template-columns: repeat(2, 1fr); } }
@@media (max-width: 420px) { .pokedex-grid { grid-template-columns: 1fr; } }
</style>
</RequireAuth>
