@page "/pokedex"
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using Microsoft.JSInterop
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Projet_FullStack_FrontEnd.Components.Pages.Pokedex> Logger
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject Projet_FullStack_FrontEnd.Services.AuthService AuthService
@implements IDisposable

<RequireAuth>
<div class="hero-content">
    <div class="hero-title">Mon Pokédex</div>

    @if (isLoading)
    {
        <p><em>Chargement de votre Pokédex…</em></p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger">Erreur : @errorMessage</p>
    }
    else
    {
        <!-- Filtres -->
        <div class="filters-container">
            <div class="filter-group">
                <label>
                    <input type="checkbox" @bind="showCapturedOnly" @bind:after="ApplyFilters" />
                    Pokémon capturés uniquement
                </label>
                <label>
                    <input type="checkbox" @bind="showUncapturedOnly" @bind:after="ApplyFilters" />
                    Pokémon non capturés uniquement
                </label>
            </div>
            <div class="stats">
                <span>Total capturés : @capturedCount / @totalPokemons</span>
                <span>Progression : @((capturedCount * 100.0 / totalPokemons).ToString("F1"))%</span>
            </div>
        </div>

        <div class="pokedex-grid">
            @foreach (var entry in filteredEntries)
            {
                <div class="pokemon-card @(entry.IsCaptured ? "captured" : "not-captured")" 
                     @onclick="() => HandleCardClick(entry)"
                     role="@(entry.IsCaptured ? "button" : "div")" 
                     tabindex="@(entry.IsCaptured ? "0" : "-1")">
                    <div class="sprite-wrap">
                        @if (entry.IsCaptured)
                        {
                            <img src="@entry.SpriteUrl" alt="@entry.Name" />
                        }
                        else
                        {
                            <div class="unknown-sprite">?</div>
                        }
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">
                            #@(entry.PokedexNumber.ToString("D3")) - @(entry.IsCaptured ? entry.Name : "???")
                        </h3>
                        @if (entry.IsCaptured)
                        {
                            <div class="types">
                                @foreach (var type in entry.Types)
                                {
                                    <span class="type @type.CssClass">@type.Display</span>
                                }
                            </div>
                            <div class="level-badge">Niv. @entry.Level</div>
                        }
                        else
                        {
                            <div class="not-captured-text">Non découvert</div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<PokedexEntry> allEntries = new();
    private List<PokedexEntry> filteredEntries = new();
    private bool isLoading = true;
    private string? errorMessage;
    private bool showCapturedOnly = false;
    private bool showUncapturedOnly = false;
    private int capturedCount = 0;
    private int totalPokemons = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadPokedex();
    }

    private async Task LoadPokedex()
    {
        isLoading = true;
        errorMessage = null;
        
        try
        {
            // 1. Récupérer le Pokédex personnel du joueur
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            
            var myPokedex = await Http.GetFromJsonAsync<List<PokemonCapture>>("api/dresseurs/pokedex");
            
            // 2. Récupérer tous les Pokémon (sans pagination, ou avec pagination complète)
            var allPokemons = await LoadAllPokemons();
            
            // 3. Créer les entrées du Pokédex
            allEntries = allPokemons.Select(pokemon =>
            {
                var capture = myPokedex?.FirstOrDefault(c => c.PokemonId == pokemon.numericId);
                return new PokedexEntry
                {
                    PokedexNumber = pokemon.numericId ?? 0,
                    Name = pokemon.nameFr ?? "???",
                    SpriteUrl = pokemon.sprites?.frontDefault ?? "",
                    IsCaptured = capture != null,
                    Level = capture?.Niveau ?? 0,
                    Types = pokemon.types?.Select(t => new TypeInfo
                    {
                        Display = t.name ?? t.nameFr ?? "",
                        CssClass = (t.nameEn ?? t.name ?? "").ToLowerInvariant().Replace(' ', '-').Replace('é','e').Replace('è','e')
                    }).ToList() ?? new List<TypeInfo>()
                };
            }).OrderBy(e => e.PokedexNumber).ToList();

            totalPokemons = allEntries.Count;
            capturedCount = allEntries.Count(e => e.IsCaptured);
            
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement du Pokédex");
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<List<Pokemon>> LoadAllPokemons()
    {
        var allPokemons = new List<Pokemon>();
        int page = 1;
        int pageSize = 100;
        bool hasMore = true;

        while (hasMore)
        {
            var response = await Http.GetFromJsonAsync<PaginatedResponse>($"api/pokemon?page={page}&pageSize={pageSize}");
            
            if (response?.items != null && response.items.Count > 0)
            {
                allPokemons.AddRange(response.items);
                hasMore = page < response.totalPages;
                page++;
            }
            else
            {
                hasMore = false;
            }
        }

        return allPokemons;
    }

    private void ApplyFilters()
    {
        filteredEntries = allEntries;

        if (showCapturedOnly && !showUncapturedOnly)
        {
            filteredEntries = allEntries.Where(e => e.IsCaptured).ToList();
        }
        else if (showUncapturedOnly && !showCapturedOnly)
        {
            filteredEntries = allEntries.Where(e => !e.IsCaptured).ToList();
        }
        else if (showCapturedOnly && showUncapturedOnly)
        {
            // Les deux cochés = tout afficher (cas contradictoire, on montre tout)
            filteredEntries = allEntries;
        }

        StateHasChanged();
    }

    void ShowDetails(int id)
    {
        NavigationManager.NavigateTo($"/pokemon/{id}");
    }

    void HandleCardClick(PokedexEntry entry)
    {
        if (entry.IsCaptured)
        {
            ShowDetails(entry.PokedexNumber);
        }
    }

    // Classes de modèles
    private class PokedexEntry
    {
        public int PokedexNumber { get; set; }
        public string Name { get; set; } = "";
        public string SpriteUrl { get; set; } = "";
        public bool IsCaptured { get; set; }
        public int Level { get; set; }
        public List<TypeInfo> Types { get; set; } = new();
    }

    private class TypeInfo
    {
        public string Display { get; set; } = "";
        public string CssClass { get; set; } = "";
    }

    private class PokemonCapture
    {
        public int PokemonId { get; set; }
        public int Niveau { get; set; }
        public DateTime DateCapture { get; set; }
    }

    private class Pokemon
    {
        public string? id { get; set; }
        public int? numericId { get; set; }
        public string? nameFr { get; set; }
        public Sprites? sprites { get; set; }
        public TypeEntry[]? types { get; set; }
        public string? description { get; set; }
    }

    private class PaginatedResponse
    {
        public List<Pokemon>? items { get; set; }
        public int page { get; set; }
        public int pageSize { get; set; }
        public int totalCount { get; set; }
        public int totalPages { get; set; }
    }

    private class Sprites
    {
        public string? frontDefault { get; set; }
        public string? frontShiny { get; set; }
    }

    private class TypeEntry
    {
        [JsonPropertyName("name")]
        public string? name { get; set; }

        [JsonPropertyName("nameEn")]
        public string? nameEn { get; set; }

        [JsonPropertyName("name_en")]
        public string? name_en { get; set; }

        [JsonPropertyName("nameFr")]
        public string? nameFr { get; set; }

        [JsonPropertyName("name_fr")]
        public string? name_fr { get; set; }

        public int slot { get; set; }
    }

    public void Dispose()
    {
        // Nettoyage si nécessaire
    }
}

<style>
/* Pokedex page styling */
.hero-content { max-width: 1100px; margin: 0 auto; padding: 1.25rem; color: #0F172A; background: #F7F9FC; min-height: 100vh; }
.hero-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; color: #E53935; }

/* Filtres */
.filters-container { 
    background: white; 
    border-radius: 12px; 
    padding: 1rem 1.5rem; 
    margin-bottom: 1.5rem; 
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
    border: 1px solid #D9E1EC;
}

.filter-group { 
    display: flex; 
    gap: 1.5rem; 
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.filter-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.95rem;
    color: #546E7A;
}

.filter-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.stats {
    display: flex;
    gap: 2rem;
    font-size: 0.9rem;
    color: #1E88E5;
    font-weight: 600;
}

/* Grille */
.pokedex-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
    gap: 1rem; 
}

.pokemon-card { 
    background: white;
    border-radius: 12px; 
    overflow: hidden; 
    transition: transform 0.28s cubic-bezier(.2,.8,.2,1), box-shadow 0.28s; 
    border: 1px solid #D9E1EC; 
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    padding: 1rem;
}

.pokemon-card.captured {
    cursor: pointer;
}

.pokemon-card.captured:focus, 
.pokemon-card.captured:hover { 
    transform: translateY(-4px); 
    box-shadow: 0 12px 24px rgba(229, 57, 53, 0.15);
    border-color: #E53935;
}

.pokemon-card.not-captured {
    opacity: 0.5;
    filter: grayscale(100%);
}

.sprite-wrap { 
    width: 120px; 
    height: 120px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    border-radius: 999px; 
    background: #F7F9FC;
    margin-bottom: 0.6rem;
}

.sprite-wrap img { 
    width: 96px; 
    height: 96px; 
    image-rendering: pixelated;
}

.unknown-sprite {
    font-size: 4rem;
    color: #D9E1EC;
    font-weight: 700;
}

.card-body { 
    text-align: center; 
    width: 100%;
}

.card-title { 
    font-size: 1.05rem; 
    margin: 0 0 0.5rem 0; 
    color: #0F172A;
    font-weight: 600;
}

.types { 
    display: flex; 
    gap: 0.5rem; 
    justify-content: center; 
    margin-top: 0.5rem; 
    flex-wrap: wrap;
}

.type { 
    padding: 0.25rem 0.65rem; 
    border-radius: 999px; 
    font-size: 0.85rem; 
    color: white; 
    box-shadow: inset 0 -2px rgba(0,0,0,0.12);
}

.level-badge {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #1E88E5;
    color: white;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
}

.not-captured-text {
    color: #546E7A;
    font-size: 0.9rem;
    font-style: italic;
    margin-top: 0.5rem;
}

/* Types colors */
.normal { background-color: #A8A878; }
.fire { background-color: #F08030; }
.water { background-color: #6890F0; }
.electric { background-color: #F8D030; color:#222; }
.grass { background-color: #78C850; }
.ice { background-color: #98D8D8; color:#222; }
.fighting { background-color: #C03028; }
.poison { background-color: #A040A0; }
.ground { background-color: #E0C068; color:#222; }
.flying { background-color: #A890F0; }
.psychic { background-color: #F85888; }
.bug { background-color: #A8B820; color:#222; }
.rock { background-color: #B8A038; }
.ghost { background-color: #705898; }
.dragon { background-color: #7038F8; }
.dark { background-color: #705848; }
.steel { background-color: #B8B8D0; color:#222; }
.fairy { background-color: #EE99AC; color:#222; }

@@media (max-width: 768px) { 
    .pokedex-grid { grid-template-columns: repeat(2, 1fr); }
    .filter-group { flex-direction: column; gap: 0.75rem; }
    .stats { flex-direction: column; gap: 0.5rem; }
}

@@media (max-width: 420px) { 
    .pokedex-grid { grid-template-columns: 1fr; }
}
</style>
</RequireAuth>
