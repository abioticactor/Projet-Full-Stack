@page "/resultats/{PartieId}"
@using System.Net.Http.Json
@implements IDisposable
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Resultats> Logger
@inject NavigationManager NavigationManager
@inject Projet_FullStack_FrontEnd.Services.AuthService AuthService

<RequireAuth>
<div class="results-container">
    @if (isLoading)
    {
        <div class="loading">
            <p>Chargement des r√©sultats...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            <p>‚ùå Erreur : @errorMessage</p>
            <button @onclick="BackToMenu">Retour au menu</button>
        </div>
    }
    else if (partie != null)
    {
        <div class="results-header">
            <h1>üèÜ R√©sultats de la Partie</h1>
            <p class="session-code">Session : @partie.CodeSession</p>
            @if (!gameFullyComplete && partie.ModeSolo != true)
            {
                <p class="waiting-message">‚è≥ En attente de la fin de partie du deuxi√®me joueur...</p>
            }
        </div>

        <!-- Scores et Vainqueur -->
        <div class="scores-section">
            <div class="player-score @(partie.ModeSolo != true && partie.ScoreJ1 > partie.ScoreJ2 ? "winner" : "")">
                <div class="player-info">
                    <h2>@player1Pseudo</h2>
                    @if (partie.ModeSolo != true && partie.ScoreJ1 > partie.ScoreJ2)
                    {
                        <span class="winner-badge">üëë Vainqueur</span>
                    }
                </div>
                <div class="score">@partie.ScoreJ1 pts</div>
                <div class="stats">
                    <span>‚úÖ @partie.CompletedPokemonsJ1.Count(p => p.WasGuessed) devin√©s</span>
                    <span>‚ùå @partie.CompletedPokemonsJ1.Count(p => !p.WasGuessed) rat√©s</span>
                </div>
            </div>

            @if (partie.ModeSolo != true)
            {
                <div class="vs-divider">VS</div>

                <div class="player-score @(partie.ScoreJ2 > partie.ScoreJ1 ? "winner" : "")">
                    <div class="player-info">
                        <h2>@player2Pseudo</h2>
                        @if (partie.ScoreJ2 > partie.ScoreJ1)
                        {
                            <span class="winner-badge">üëë Vainqueur</span>
                        }
                        @if (!gameFullyComplete && partie.CompletedPokemonsJ2.Count == 0)
                        {
                            <span class="loading-badge">‚è≥ En cours...</span>
                        }
                    </div>
                    <div class="score">@partie.ScoreJ2 pts</div>
                    <div class="stats">
                        <span>‚úÖ @partie.CompletedPokemonsJ2.Count(p => p.WasGuessed) devin√©s</span>
                        <span>‚ùå @partie.CompletedPokemonsJ2.Count(p => !p.WasGuessed) rat√©s</span>
                    </div>
                </div>
            }
        </div>

        @if (partie.ScoreJ1 == partie.ScoreJ2 && gameFullyComplete && partie.ModeSolo != true)
        {
            <div class="draw-message">
                ü§ù Match nul ! Les deux joueurs sont √† √©galit√© !
            </div>
        }

        <!-- D√©tails des Pok√©mons -->
        <div class="pokemons-details">
            <h2>D√©tails des Pok√©mons</h2>
            
            <div class="pokemons-grid">
                <!-- Colonne Joueur 1 -->
                <div class="player-column">
                    <h3>@player1Pseudo</h3>
                    @if (partie.CompletedPokemonsJ1.Any())
                    {
                        @foreach (var pokemon in partie.CompletedPokemonsJ1)
                        {
                            <div class="pokemon-card @(pokemon.WasGuessed ? "guessed" : "failed")">
                                <div class="pokemon-header">
                                    <img src="@GetPokemonSprite(pokemon.PokemonId)" alt="@pokemon.PokemonName" class="pokemon-sprite" />
                                    <div class="pokemon-info">
                                        <h4>@pokemon.PokemonName</h4>
                                        <span class="status-badge">
                                            @(pokemon.WasGuessed ? "‚úÖ Devin√©" : "‚ùå Rat√©")
                                        </span>
                                    </div>
                                </div>
                                <div class="pokemon-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Tentatives :</span>
                                        <span class="stat-value">@pokemon.AttemptsUsed / 3</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Indices utilis√©s :</span>
                                        <span class="stat-value">@pokemon.HintsUsed.Count</span>
                                    </div>
                                    @if (pokemon.HintsUsed.Any())
                                    {
                                        <div class="hints-used">
                                            @foreach (var hint in pokemon.HintsUsed)
                                            {
                                                <span class="hint-tag">@hint</span>
                                            }
                                        </div>
                                    }
                                    <div class="stat-item points">
                                        <span class="stat-label">Points :</span>
                                        <span class="stat-value">@pokemon.PointsEarned pts</span>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">Aucun Pok√©mon compl√©t√©</p>
                    }
                </div>

                <!-- Colonne Joueur 2 (masqu√©e en mode solo) -->
                @if (partie.ModeSolo != true)
                {
                    <div class="player-column">
                        <h3>@player2Pseudo</h3>
                        @if (partie.CompletedPokemonsJ2.Any())
                        {
                            @foreach (var pokemon in partie.CompletedPokemonsJ2)
                            {
                                <div class="pokemon-card @(pokemon.WasGuessed ? "guessed" : "failed")">
                                    <div class="pokemon-header">
                                        <img src="@GetPokemonSprite(pokemon.PokemonId)" alt="@pokemon.PokemonName" class="pokemon-sprite" />
                                        <div class="pokemon-info">
                                            <h4>@pokemon.PokemonName</h4>
                                            <span class="status-badge">
                                                @(pokemon.WasGuessed ? "‚úÖ Devin√©" : "‚ùå Rat√©")
                                            </span>
                                        </div>
                                    </div>
                                    <div class="pokemon-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Tentatives :</span>
                                            <span class="stat-value">@pokemon.AttemptsUsed / 3</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Indices utilis√©s :</span>
                                            <span class="stat-value">@pokemon.HintsUsed.Count</span>
                                        </div>
                                        @if (pokemon.HintsUsed.Any())
                                        {
                                            <div class="hints-used">
                                                @foreach (var hint in pokemon.HintsUsed)
                                                {
                                                    <span class="hint-tag">@hint</span>
                                                }
                                            </div>
                                        }
                                        <div class="stat-item points">
                                            <span class="stat-label">Points :</span>
                                            <span class="stat-value">@pokemon.PointsEarned pts</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (!gameFullyComplete)
                        {
                            <p class="loading-data">‚è≥ R√©sultats en cours de chargement...</p>
                        }
                        else
                        {
                            <p class="no-data">Aucun Pok√©mon compl√©t√©</p>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
            <button @onclick="NewGame" class="action-button primary" disabled="@(gameFullyComplete ? false : true)">
                üéÆ Nouvelle partie
            </button>
            <button @onclick="BackToMenu" class="action-button secondary">
                üè† Menu principal
            </button>
        </div>
    }
</div>
</RequireAuth>

@code {
    [Parameter]
    public string PartieId { get; set; } = string.Empty;

    private bool isLoading = true;
    private string? errorMessage;
    private PartieDto? partie;
    private string player1Pseudo = string.Empty;
    private string player2Pseudo = string.Empty;
    private Dictionary<string, string> pokemonSprites = new();
    private bool gameFullyComplete = false;
    private System.Threading.Timer? autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadResults();
        StartAutoRefresh();
    }

    public void Dispose()
    {
        autoRefreshTimer?.Dispose();
    }

    private void StartAutoRefresh()
    {
        // Rafra√Æchir tous les 2 secondes si la partie n'est pas compl√®tement termin√©e
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!gameFullyComplete)
                {
                    await RefreshResults();
                }
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private async Task RefreshResults()
    {
        try
        {
            var response = await Http.GetAsync($"api/partie/{PartieId}");
            if (response.IsSuccessStatusCode)
            {
                var newPartie = await response.Content.ReadFromJsonAsync<PartieDto>();
                if (newPartie != null)
                {
                    // V√©rifier si les donn√©es ont chang√©
                    if (newPartie.CompletedPokemonsJ2.Count != partie?.CompletedPokemonsJ2.Count)
                    {
                        partie = newPartie;
                        await LoadPokemonSprites();
                        StateHasChanged();

                        Logger.LogInformation($"R√©sultats mise √† jour: J1={partie.CompletedPokemonsJ1.Count}, J2={partie.CompletedPokemonsJ2.Count}");
                    }

                    // V√©rifier si la partie est compl√®tement termin√©e
                    if (partie?.CompletedPokemonsJ1.Count > 0 && partie?.CompletedPokemonsJ2.Count > 0)
                    {
                        gameFullyComplete = true;
                        StopAutoRefresh();
                        StateHasChanged();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du rafra√Æchissement des r√©sultats");
        }
    }

    private void StopAutoRefresh()
    {
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = null;
    }

    private async Task LoadResults()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var response = await Http.GetAsync($"api/partie/{PartieId}");
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();

            if (partie == null)
            {
                errorMessage = "Impossible de charger les r√©sultats de la partie";
                return;
            }

            // V√©rifier si les r√©sultats des deux joueurs sont pr√©sents
            gameFullyComplete = partie.CompletedPokemonsJ1.Count > 0 && partie.CompletedPokemonsJ2.Count > 0;

            await LoadPlayersPseudos(partie.Dresseur1Id, partie.Dresseur2Id);
            await LoadPokemonSprites();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des r√©sultats");
            errorMessage = $"Erreur : {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadPlayersPseudos(string? dresseur1Id, string? dresseur2Id)
    {
        try
        {
            if (!string.IsNullOrEmpty(dresseur1Id))
            {
                var response1 = await Http.GetAsync($"api/dresseurs/{dresseur1Id}");
                if (response1.IsSuccessStatusCode)
                {
                    var dresseur1 = await response1.Content.ReadFromJsonAsync<DresseurDto>();
                    player1Pseudo = dresseur1?.Pseudo ?? "Joueur 1";
                }
                else
                {
                    player1Pseudo = "Joueur 1";
                }
            }

            if (!string.IsNullOrEmpty(dresseur2Id))
            {
                var response2 = await Http.GetAsync($"api/dresseurs/{dresseur2Id}");
                if (response2.IsSuccessStatusCode)
                {
                    var dresseur2 = await response2.Content.ReadFromJsonAsync<DresseurDto>();
                    player2Pseudo = dresseur2?.Pseudo ?? "Joueur 2";
                }
                else
                {
                    player2Pseudo = "Joueur 2";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des pseudos");
            player1Pseudo = "Joueur 1";
            player2Pseudo = "Joueur 2";
        }
    }

    private async Task LoadPokemonSprites()
    {
        if (partie == null) return;

        var allCompletedPokemons = partie.CompletedPokemonsJ1.Concat(partie.CompletedPokemonsJ2).ToList();

        foreach (var pokemon in allCompletedPokemons)
        {
            if (!pokemonSprites.ContainsKey(pokemon.PokemonId))
            {
                try
                {
                    var response = await Http.GetAsync($"api/pokemon/{pokemon.PokemonId}/hints");
                    if (response.IsSuccessStatusCode)
                    {
                        var hints = await response.Content.ReadFromJsonAsync<PokemonHintsDto>();
                        if (hints?.Sprites?.FrontDefault != null)
                        {
                            pokemonSprites[pokemon.PokemonId] = hints.Sprites.FrontDefault;
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, $"Erreur lors du chargement du sprite pour {pokemon.PokemonId}");
                }
            }
        }
    }

    private string GetPokemonSprite(string pokemonId)
    {
        return pokemonSprites.TryGetValue(pokemonId, out var sprite) 
            ? sprite 
            : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/0.png";
    }

    private void NewGame()
    {
        NavigationManager.NavigateTo("/partie");
    }

    private void BackToMenu()
    {
        NavigationManager.NavigateTo("/");
    }

    // DTOs
    public class PartieDto
    {
        public string? Id { get; set; }
        public string? CodeSession { get; set; }
        public string? Statut { get; set; }
        public string? Dresseur1Id { get; set; }
        public string? Dresseur2Id { get; set; }
        public bool ModeSolo { get; set; } = false;
        public int ScoreJ1 { get; set; }
        public int ScoreJ2 { get; set; }
        public List<CompletedPokemonDto> CompletedPokemonsJ1 { get; set; } = new();
        public List<CompletedPokemonDto> CompletedPokemonsJ2 { get; set; } = new();
    }

    public class CompletedPokemonDto
    {
        public string PokemonId { get; set; } = string.Empty;
        public string PokemonName { get; set; } = string.Empty;
        public bool WasGuessed { get; set; }
        public int AttemptsUsed { get; set; }
        public List<string> HintsUsed { get; set; } = new();
        public int PointsEarned { get; set; }
    }

    public class DresseurDto
    {
        public string? Id { get; set; }
        public string? Pseudo { get; set; }
    }

    public class PokemonHintsDto
    {
        public SpritesDto? Sprites { get; set; }
    }

    public class SpritesDto
    {
        public string? FrontDefault { get; set; }
    }
}

<style>
    :root {
        --color-red: #E53935;
        --color-blue: #1E88E5;
        --color-orange: #FF9800;
        --color-green: #2E7D32;
        --color-white: #FFFFFF;
        --color-bg: #F7F9FC;
        --color-text: #2C3E50;
        --color-text-light: #7F8C8D;
        --color-border: #E0E0E0;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.12);
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
    }

    .results-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-xl);
        color: var(--color-text);
    }

    .loading, .error-message {
        text-align: center;
        padding: var(--space-xl) var(--space-lg);
        background: var(--color-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 2px solid var(--color-border);
    }

    .error-message p {
        color: var(--color-red);
        margin-bottom: var(--space-md);
    }

    .results-header {
        text-align: center;
        margin-bottom: var(--space-xl);
        background: var(--color-white);
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .results-header h1 {
        font-size: 2.5rem;
        margin-bottom: var(--space-sm);
        color: var(--color-blue);
        font-weight: 700;
    }

    .session-code {
        color: var(--color-text-light);
        font-size: 1rem;
    }

    .waiting-message {
        color: var(--color-orange);
        font-size: 1.1rem;
        margin-top: var(--space-sm);
        font-weight: 500;
        animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-badge {
        display: inline-block;
        background: rgba(255, 152, 0, 0.1);
        color: var(--color-orange);
        padding: var(--space-xs) var(--space-md);
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid var(--color-orange);
        animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-data {
        text-align: center;
        color: var(--color-orange);
        font-style: italic;
        padding: var(--space-xl);
        animation: pulse 1.5s ease-in-out infinite;
    }

    /* Scores Section */
    .scores-section {
        display: flex;
        gap: var(--space-xl);
        justify-content: center;
        align-items: stretch;
        margin-bottom: var(--space-xl);
        flex-wrap: wrap;
    }

    .player-score {
        flex: 1;
        min-width: 300px;
        max-width: 500px;
        background: var(--color-white);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        text-align: center;
        transition: all 0.3s;
        box-shadow: var(--shadow-sm);
    }

    .player-score.winner {
        border-color: #FFD700;
        background: linear-gradient(to bottom, #FFF9E6, var(--color-white));
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
    }

    .player-info {
        margin-bottom: var(--space-md);
    }

    .player-info h2 {
        margin: 0 0 var(--space-sm) 0;
        color: var(--color-blue);
        font-size: 1.8rem;
        font-weight: 600;
    }

    .winner-badge {
        display: inline-block;
        background: linear-gradient(135deg, #FFD700, #FFC107);
        color: #000;
        padding: var(--space-sm) var(--space-md);
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }

    .score {
        font-size: 3rem;
        font-weight: 700;
        color: var(--color-blue);
        margin: var(--space-md) 0;
    }

    .stats {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        flex-wrap: wrap;
        color: var(--color-text-light);
        font-size: 0.9rem;
    }

    .vs-divider {
        display: flex;
        align-items: center;
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-light);
    }

    .draw-message {
        text-align: center;
        background: rgba(255, 152, 0, 0.1);
        border: 2px solid var(--color-orange);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-xl);
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--color-orange);
        box-shadow: var(--shadow-sm);
    }

    /* Pok√©mons Details */
    .pokemons-details {
        margin-bottom: var(--space-xl);
    }

    .pokemons-details > h2 {
        text-align: center;
        color: var(--color-blue);
        margin-bottom: var(--space-xl);
        font-size: 2rem;
        font-weight: 600;
    }

    .pokemons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xl);
    }

    @@media (max-width: 1024px) {
        .pokemons-grid {
            grid-template-columns: 1fr;
        }
    }

    .player-column {
        background: var(--color-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        box-shadow: var(--shadow-sm);
        border: 2px solid var(--color-border);
    }

    .player-column > h3 {
        color: var(--color-blue);
        margin-top: 0;
        margin-bottom: var(--space-lg);
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .pokemon-card {
        background: #FAFAFA;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        transition: all 0.2s ease;
    }

    .pokemon-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .pokemon-card.guessed {
        border-color: var(--color-green);
        background: rgba(46, 125, 50, 0.05);
    }

    .pokemon-card.failed {
        border-color: var(--color-red);
        background: rgba(229, 57, 53, 0.05);
    }

    .pokemon-header {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
        padding-bottom: var(--space-md);
        border-bottom: 2px solid var(--color-border);
    }

    .pokemon-sprite {
        width: 80px;
        height: 80px;
        image-rendering: pixelated;
        background: var(--color-white);
        border-radius: var(--radius-sm);
        padding: var(--space-xs);
    }

    .pokemon-info {
        flex: 1;
    }

    .pokemon-info h4 {
        margin: 0 0 var(--space-sm) 0;
        color: var(--color-text);
        font-size: 1.2rem;
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-md);
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid;
    }

    .pokemon-card.guessed .status-badge {
        background: rgba(46, 125, 50, 0.1);
        color: var(--color-green);
        border-color: var(--color-green);
    }

    .pokemon-card.failed .status-badge {
        background: rgba(229, 57, 53, 0.1);
        color: var(--color-red);
        border-color: var(--color-red);
    }

    .pokemon-stats {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .stat-label {
        color: var(--color-text-light);
        font-size: 0.9rem;
    }

    .stat-value {
        color: var(--color-text);
        font-weight: 600;
    }

    .stat-item.points {
        margin-top: var(--space-sm);
        padding-top: var(--space-sm);
        border-top: 2px solid var(--color-border);
    }

    .stat-item.points .stat-value {
        color: var(--color-blue);
        font-size: 1.1rem;
        font-weight: 700;
    }

    .hints-used {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        margin-top: var(--space-sm);
    }

    .hint-tag {
        background: rgba(30, 136, 229, 0.1);
        color: var(--color-blue);
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-md);
        font-size: 0.8rem;
        border: 1px solid rgba(30, 136, 229, 0.3);
        font-weight: 500;
    }

    .no-data {
        text-align: center;
        color: var(--color-text-light);
        font-style: italic;
        padding: var(--space-xl);
    }

    /* Actions */
    .actions-section {
        display: flex;
        gap: var(--space-md);
        justify-content: center;
        flex-wrap: wrap;
    }

    .action-button {
        padding: var(--space-md) var(--space-xl);
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 44px;
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .action-button:active {
        transform: translateY(0);
    }

    .action-button.primary {
        background: var(--color-blue);
        color: white;
    }

    .action-button.primary:hover {
        background: #1976D2;
    }

    .action-button.secondary {
        background: var(--color-white);
        color: var(--color-text);
        border: 2px solid var(--color-border);
    }

    .action-button.secondary:hover {
        border-color: var(--color-blue);
        color: var(--color-blue);
    }

    button {
        font-family: inherit;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }
</style>
