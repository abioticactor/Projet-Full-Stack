@page "/partie"
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Projet_FullStack_FrontEnd.Components.Pages.Partie> Logger
@inject NavigationManager NavigationManager

<div class="hero-content">

    @if (isLoading)
    {
        <p><em>Chargement…</em></p>
    }
    else
    {
        if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="text-danger">Erreur : @errorMessage</p>
        }
            @if (!hideOptions && string.IsNullOrEmpty(currentPartieId))
            {
                <div class="game-options">
                    <div class="option-column">
                        <div class="option-card create-card large-option">
                            <h3>Créer une partie</h3>
                            <p class="card-desc">Créez une nouvelle partie et obtenez un code de session à partager.</p>
                            <button class="tab-btn" @onclick="CreateGame" disabled="@isLoading">Créer</button>
                        </div>
                    </div>

                    <div class="option-column">
                        <div class="option-card join-card large-option">
                            <h3>Rejoindre une partie</h3>
                            <p class="card-desc">Entrez le code de session fourni par l'hôte pour rejoindre.</p>
                            <p class="form-error text-danger @(string.IsNullOrEmpty(joinErrorMessage) ? "empty" : "")" aria-live="polite">@joinErrorMessage</p>
                            <input type="text" @bind="codeSession" placeholder="Code de session" />
                            <button class="tab-btn" @onclick="JoinGame" disabled="@isLoading">Rejoindre</button>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="session-container">
                    @if (partie != null)
                    {
                        <div class="partie-info">
                            <p class="session-label">Code session</p>
                            <p class="session-code">@partie.CodeSession</p>
                        </div>

                        <div class="players-section">
                            <div class="player-card player-1">
                                <p class="player-label">Joueur 1</p>
                                <p class="player-name">@GetPlayerDisplay(partie.Dresseur1Id)</p>
                            </div>
                            <div class="player-card player-2">
                                <p class="player-label">Joueur 2</p>
                                <p class="player-name">@GetPlayerDisplay(partie.Dresseur2Id)</p>
                            </div>
                        </div>
                    }

                    <div class="start-section">
                        <div class="option-card large-start">
                            <h3>Démarrer la partie</h3>
                            <div style="display: flex; gap: 1rem; width: 100%; justify-content: center;">
                                <button @onclick="StartGame" disabled="@isLoading">Démarrer (Mode Standard)</button>
                                <button @onclick="GoBack" disabled="@isLoading" style="background: #6c757d;">Retour</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
</div>

@code {
    private string dresseurId = "user123"; // À récupérer de la session/contexte
    private string codeSession = string.Empty;
    private string? joinErrorMessage = null;
    private string currentPartieId = string.Empty;
    private bool hideOptions = false;
    private bool isLoading = false;
    private string? errorMessage;
    private PartieDto? partie;

    // API: Créer une partie
    private async Task CreateGame()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var request = new CreateGameRequest { DresseurId = dresseurId };
            var response = await Http.PostAsJsonAsync("api/partie/create", request);
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            currentPartieId = partie?.Id ?? string.Empty;
            hideOptions = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la création");
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

        // Retour à la config: masquer section démarrer et réafficher options créer/rejoindre
        private void GoBack()
        {
            hideOptions = false;
            currentPartieId = string.Empty;
            codeSession = string.Empty;
            errorMessage = null;
            joinErrorMessage = null;
            partie = null;
        }


    // API: Rejoindre une partie
    private async Task JoinGame()
    {
        if (string.IsNullOrEmpty(codeSession))
        {
            joinErrorMessage = "Veuillez entrer un code de session";
            return;
        }

        isLoading = true;
        errorMessage = null;
        try
        {
            var request = new JoinGameRequest 
            { 
                CodeSession = codeSession, 
                DresseurId = dresseurId 
            };
            var response = await Http.PostAsJsonAsync("api/partie/join", request);
            if (!response.IsSuccessStatusCode)
            {
                if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
                {
                    joinErrorMessage = "Veuillez entrer un code de session valide";
                }
                else
                {
                    joinErrorMessage = $"Erreur: {(response.ReasonPhrase ?? response.StatusCode.ToString())}";
                }
                return;
            }
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            currentPartieId = partie?.Id ?? string.Empty;
            joinErrorMessage = null;
            hideOptions = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la connexion");
            joinErrorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    // API: Démarrer la partie
    private async Task StartGame()
    {
        if (string.IsNullOrEmpty(currentPartieId))
        {
            errorMessage = "Aucune partie sélectionnée";
            return;
        }

        isLoading = true;
        errorMessage = null;
        try
        {
            var request = new StartGameRequest { Mode = "Standard" };
            var response = await Http.PostAsJsonAsync(
                $"api/partie/{currentPartieId}/start", 
                request
            );
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            // Redirection vers la page de jeu
            NavigationManager.NavigateTo($"/guess/{currentPartieId}/{dresseurId}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du démarrage");
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    // DTOs locaux (ou à partager)
    private class CreateGameRequest { public string DresseurId { get; set; } = string.Empty; }
    private class JoinGameRequest 
    { 
        public string CodeSession { get; set; } = string.Empty;
        public string DresseurId { get; set; } = string.Empty;
    }
    private class StartGameRequest { public string Mode { get; set; } = string.Empty; }
    
    private class PartieDto
    {
        public string? Id { get; set; }
        public string? CodeSession { get; set; }
        public string? Status { get; set; }
        public string? Dresseur1Id { get; set; }
        public string? Dresseur2Id { get; set; }
    }

    private string GetPlayerDisplay(string? dresseurIdValue)
    {
        if (string.IsNullOrEmpty(dresseurIdValue)) return "En attente...";
        return dresseurIdValue == dresseurId ? "Vous" : dresseurIdValue;
    }
}

<style>
    /* Make the page take the full viewport and ensure the two sections share space evenly */
    .hero-content { width: 100%; max-width: none; margin: 0; padding: 1.5rem; color: #000000; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
    .hero-title { font-size: 2.4rem; margin: 0 0 1rem 0; font-weight: 700; }

    /* Two equal columns, with spacing between them */
    .game-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: stretch; flex: 0 1 auto; }
    .option-column { display: flex; }
    .option-card { background: rgba(255,255,255,0.05); padding: 1.6rem; border-radius: 8px; border: none; width: 100%; box-shadow: 0 6px 18px rgba(0,0,0,0.12); display: flex; flex-direction: column; gap: 0.9rem; height: 100%; justify-content: flex-start; align-items: stretch; color: #000; text-align: center; }
    .option-card h3 { margin: 0 0 0.5rem 0; font-size: 1.9rem; line-height: 1.08; color: #ffffff; }
    .option-card p { font-size: 1.05rem; color: #000; max-width: 36rem; margin: 0 auto; }
    .card-desc { font-size: 1.4rem; font-weight: 600; color: #000; white-space: nowrap; max-width: 100%; overflow: visible; text-overflow: clip; }
    .option-card input { padding: 0.6rem; width: 100%; margin-bottom: 0.6rem; border-radius: 8px; border: 1px solid rgba(0,0,0,0.12); color: #000; font-size: 1rem; text-align: center; }
    .option-card button { padding: 0.9rem 1.6rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1.05rem; font-weight: 600; margin-top: auto; }
    .tab-btn { background: #196a9e !important; color: #ffffff !important; }
    .tab-btn:hover:not(:disabled) { filter: brightness(0.95); }
    .tab-btn:active:not(:disabled) { filter: brightness(0.9); }
    .card-desc { color: #196a9e !important; white-space: nowrap; max-width: 100%; overflow: visible; text-overflow: clip; }
    /* Ensure buttons have good contrast on the new tab color */
    .option-card.create-card button, .option-card.join-card button { color: #ffffff; background: #28aafd; border: none; }

    /* Variantes visuelles pour chaque section */
    /* Use requested tab color */
    .create-card { background: linear-gradient(180deg, rgba(40, 170, 253), rgba(31, 133, 199)); border: 0; }
    .join-card { background: linear-gradient(180deg, rgba(40, 170, 253), rgba(31, 133, 199)); border: 0; }

    /* Enlarged option card variant for create/join tabs */
    .option-card.large-option { padding: 2.4rem; min-height: 22rem; }
    .option-card.large-option h3 { font-size: 2.6rem; }
    .option-card.large-option p { font-size: 1.15rem; }
    .option-card.large-option input { padding: 1rem; font-size: 1.05rem; }
    .option-card.large-option button { padding: 1.25rem 2rem; font-size: 1.25rem; border-radius: 10px; }
    .form-error { min-height: 1.3rem; margin: 0 0 0.5rem 0; color: #dc3545; font-size: 1rem; line-height: 1.2rem; }
    .form-error.empty { visibility: hidden; }

    /* Section de démarrage distincte */
    .start-section { margin-top: 1.5rem; flex: 0 0 auto; }

    /* zone d'info */
    .partie-info { margin-top: 2rem; padding: 1.25rem; background: #f1f1f1; border-radius: 8px; color: #000; font-size: 1.05rem; flex: 0 0 auto; }

    /* prominent centered code session */
    .partie-info .session-label { text-align: center; margin: 0; font-size: 0.95rem; color: #333; font-weight: 600; }
    .partie-info .session-code { text-align: center; margin: 0.6rem auto 0; font-size: 3rem; font-weight: 800; letter-spacing: 0.08em; color: #000; max-width: 34rem; }

    /* players section */
    .players-section { display: flex; gap: 0.75rem; margin-top: 1rem; justify-content: space-between; align-items: stretch; width: 100%; flex: 0 0 auto; min-height: 64px; }
    .player-card { background: #fff; padding: 0.75rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); flex: 1 1 0; min-width: 10rem; text-align: center; height: 100%; display:flex; flex-direction:column; justify-content:center; }
    .player-card .player-label { margin: 0; font-weight: 700; color: #333; }
    .player-card .player-name { margin: 0.5rem 0 0; font-size: 1.15rem; font-weight: 700; color: #111; }

    /* Start section: larger action card */
    .option-card.large-start { padding: 1.2rem; min-height: 14rem; }
    .option-card.large-start h3 { font-size: 2.4rem; }
    .option-card.large-start button { padding: 1rem 2rem; font-size: 1.1rem; }

    /* Session container takes available height */
    .session-container { display: flex; flex-direction: column; gap: 1rem; flex: 1 1 auto; height: calc(100vh - 6rem); }

    /* Responsive: empile sur petits écrans */
    @@media (max-width: 900px) {
        .game-options { grid-template-columns: 1fr; gap: 1rem; }
        .option-card { align-items: stretch; padding: 1rem; }
        .option-card.large-option { padding: 1.2rem; min-height: 14rem; }
        .card-desc { font-size: 1.05rem; }
        .option-card.large-option h3 { font-size: 1.6rem; }
        .hero-title { font-size: 2rem; }
        .option-card h3 { font-size: 1.6rem; }
        .option-card p { font-size: 1.05rem; }
        .partie-info .session-code { font-size: 1.8rem; }
        .option-card input { font-size: 1rem; }
        .option-card button { font-size: 1.05rem; padding: 0.9rem 1.25rem; margin-top: 0.5rem; }
        .partie-info { font-size: 1rem; }
        .partie-info .session-code { font-size: 1.8rem; }
        .players-section { flex-direction: column; gap: 0.6rem; }
        .player-card { max-width: none; width: 100%; padding: 0.75rem; }
        .option-card.large-start { padding: 0.9rem; min-height: 11rem; }
        .option-card.large-start h3 { font-size: 1.6rem; }
    }
</style>
