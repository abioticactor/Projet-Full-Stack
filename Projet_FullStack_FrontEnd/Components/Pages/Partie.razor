@page "/partie"
@using System.Net.Http.Json
@using System.Text.Json.Serialization
@using Microsoft.JSInterop
@implements IDisposable
@inject HttpClient Http
@inject Microsoft.Extensions.Logging.ILogger<Projet_FullStack_FrontEnd.Components.Pages.Partie> Logger
@inject NavigationManager NavigationManager
@inject Projet_FullStack_FrontEnd.Services.AuthService AuthService
@inject Projet_FullStack_FrontEnd.Services.UserStateService UserState
@inject IJSRuntime JSRuntime

<RequireAuth>
<div class="hero-content">
    <div class="hero-title">D√©buter une Partie - @UserState.CurrentUser?.Pseudo</div>

    @if (isLoading || UserState.IsLoading)
    {
        <p><em>Chargement‚Ä¶</em></p>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <p class="text-danger">Erreur : @errorMessage</p>
    }
    else
    {
        @if (string.IsNullOrEmpty(currentPartieId))
        {
            <div class="game-options">
                <!-- Option 1: Cr√©er une partie -->
                <div class="option-card">
                    <h3>üéÆ Cr√©er une partie</h3>
                    <p class="card-description">Cr√©ez une nouvelle session et partagez le code avec un ami</p>
                    <button @onclick="CreateGame" disabled="@isLoading">Cr√©er une nouvelle partie</button>
                </div>

                <!-- Option 2: Rejoindre une partie -->
                <div class="option-card">
                    <h3>üîó Rejoindre une partie</h3>
                    <p class="card-description">Entrez le code de session fourni par votre ami</p>
                    <input type="text" @bind="codeSession" placeholder="Code de session" />
                    <button @onclick="JoinGame" disabled="@isLoading">Rejoindre la partie</button>
                </div>
            </div>
        }
        else
        {
            <!-- Salle d'attente / Lobby -->
            <div class="lobby-container">
                <div class="lobby-header">
                    <h2>üéØ Salle d'attente</h2>
                    <div class="session-code-display">
                        <span class="label">Code de session :</span>
                        <span class="code">@partie?.CodeSession</span>
                        <button class="copy-btn" @onclick="CopySessionCode" title="Copier le code">üìã</button>
                    </div>
                </div>

                <div class="players-status">
                    <div class="player-card @(isPlayer1 ? "current-player" : "")">
                        <div class="player-icon">üë§</div>
                        <div class="player-info">
                            <div class="player-name">@(string.IsNullOrEmpty(player1Pseudo) ? "Joueur 1" : player1Pseudo)</div>
                        </div>
                        @if (isPlayer1)
                        {
                            <span class="you-badge">Vous</span>
                        }
                    </div>

                    <div class="vs-divider">VS</div>

                    <div class="player-card @(!isPlayer1 ? "current-player" : "")">
                        <div class="player-icon">üë§</div>
                        <div class="player-info">
                            <div class="player-name">@(string.IsNullOrEmpty(player2Pseudo) ? "En attente..." : player2Pseudo)</div>
                        </div>
                        @if (!isPlayer1)
                        {
                            <span class="you-badge">Vous</span>
                        }
                    </div>
                </div>

                <div class="lobby-actions">
                    @if (partie?.Statut == "Pr√™t")
                    {
                        <div class="ready-message">
                            <p>‚úÖ Les deux joueurs sont connect√©s !</p>
                        </div>
                        <button class="start-btn" @onclick="StartGame" disabled="@isLoading">
                            üöÄ D√©marrer la partie (Mode Standard)
                        </button>
                    }
                    else if (partie?.Statut == "EnAttente")
                    {
                        <div class="waiting-message">
                            <p>‚è≥ En attente du second joueur...</p>
                            <p class="hint">Partagez le code <strong>@partie?.CodeSession</strong> avec votre ami</p>
                        </div>
                        <button class="refresh-btn" @onclick="() => RefreshGameStatus()" disabled="@isLoading">
                            üîÑ Actualiser
                        </button>
                    }
                    else
                    {
                        <div class="status-message">
                            <p>Statut : @partie?.Statut</p>
                        </div>
                    }

                    <button class="cancel-btn" @onclick="CancelLobby">Annuler</button>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="success-message">
                @successMessage
            </div>
        }
    }
</div>
</RequireAuth>

@code {
    private string codeSession = string.Empty;
    private string currentPartieId = string.Empty;
    private bool isLoading = false;
    private string? errorMessage;
    private string? successMessage;
    private PartieDto? partie;
    
    private string player1Pseudo = string.Empty;
    private string player2Pseudo = string.Empty;
    private bool isPlayer1 = false;
    private System.Threading.Timer? autoRefreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await UserState.LoadUserDataAsync();
    }

    public void Dispose()
    {
        autoRefreshTimer?.Dispose();
    }

    private void StartAutoRefresh()
    {
        // Rafra√Æchir toutes les 2 secondes
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!string.IsNullOrEmpty(currentPartieId) && partie?.Statut == "EnAttente")
                {
                    await RefreshGameStatus(silent: true);
                }
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private void StopAutoRefresh()
    {
        autoRefreshTimer?.Dispose();
        autoRefreshTimer = null;
    }

    // API: Cr√©er une partie
    private async Task CreateGame()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;
        try
        {
            var request = new CreateGameRequest { DresseurId = AuthService.CurrentUserId ?? "" };
            var response = await Http.PostAsJsonAsync("api/partie/create", request);
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            Logger.LogInformation($"Partie cr√©√©e: ID={partie?.Id}, Code={partie?.CodeSession}, Statut={partie?.Statut}");
            Logger.LogInformation($"Dresseur1Id={partie?.Dresseur1Id}, Dresseur2Id={partie?.Dresseur2Id}");
            
            currentPartieId = partie?.Id ?? string.Empty;
            await LoadPlayersInfo();
            successMessage = $"Partie cr√©√©e avec succ√®s ! Code: {partie?.CodeSession}";
            
            // D√©marrer le rafra√Æchissement automatique pour d√©tecter quand J2 rejoint
            StartAutoRefresh();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la cr√©ation");
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    // API: Rejoindre une partie
    private async Task JoinGame()
    {
        if (string.IsNullOrEmpty(codeSession))
        {
            errorMessage = "Veuillez entrer un code de session";
            return;
        }

        isLoading = true;
        errorMessage = null;
        successMessage = null;
        try
        {
            Logger.LogInformation($"Tentative de rejoindre la partie avec le code: {codeSession}");
            
            var request = new JoinGameRequest 
            { 
                CodeSession = codeSession.Trim().ToUpper(), // Normaliser le code
                DresseurId = AuthService.CurrentUserId ?? "" 
            };
            
            Logger.LogInformation($"DresseurId: {request.DresseurId}");
            
            var response = await Http.PostAsJsonAsync("api/partie/join", request);
            
            if (!response.IsSuccessStatusCode)
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError($"Erreur serveur: {response.StatusCode} - {errorContent}");
                errorMessage = $"Impossible de rejoindre: {errorContent}";
                return;
            }
            
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            Logger.LogInformation($"Partie rejointe: {partie?.Id}, Statut: {partie?.Statut}");
            Logger.LogInformation($"Dresseur1Id={partie?.Dresseur1Id}, Dresseur2Id={partie?.Dresseur2Id}");
            
            currentPartieId = partie?.Id ?? string.Empty;
            await LoadPlayersInfo();
            successMessage = "Vous avez rejoint la partie avec succ√®s !";
            
            // Pas besoin d'auto-refresh pour J2 car la partie est d√©j√† "Pr√™t"
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la connexion");
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    // API: D√©marrer la partie
    private async Task StartGame()
    {
        if (string.IsNullOrEmpty(currentPartieId))
        {
            errorMessage = "Aucune partie s√©lectionn√©e";
            return;
        }

        isLoading = true;
        errorMessage = null;
        try
        {
            var request = new StartGameRequest { Mode = "Standard" };
            var response = await Http.PostAsJsonAsync(
                $"api/partie/{currentPartieId}/start", 
                request
            );
            response.EnsureSuccessStatusCode();
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            // Redirection vers la page de jeu avec le pseudo dans l'URL
            var pseudo = AuthService.CurrentPseudo ?? "Joueur";
            NavigationManager.NavigateTo($"/guess/{currentPartieId}/{pseudo}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du d√©marrage");
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally { isLoading = false; }
    }

    private async Task LoadPlayersInfo()
    {
        if (partie == null) return;

        try
        {
            // D√©terminer si l'utilisateur actuel est le joueur 1 ou 2
            string currentUserId = AuthService.CurrentUserId ?? "";
            isPlayer1 = partie.Dresseur1Id == currentUserId;
            
            Logger.LogInformation($"LoadPlayersInfo - CurrentUser: {currentUserId}, IsPlayer1: {isPlayer1}");
            Logger.LogInformation($"Dresseur1Id: {partie.Dresseur1Id}, Dresseur2Id: {partie.Dresseur2Id}");

            // Charger le pseudo du joueur 1
            if (!string.IsNullOrEmpty(partie.Dresseur1Id))
            {
                if (partie.Dresseur1Id == currentUserId)
                {
                    player1Pseudo = AuthService.CurrentPseudo ?? "Joueur 1";
                    Logger.LogInformation($"Player1 (Vous): {player1Pseudo}");
                }
                else
                {
                    var response = await Http.GetAsync($"api/dresseurs/{partie.Dresseur1Id}");
                    if (response.IsSuccessStatusCode)
                    {
                        var dresseur = await response.Content.ReadFromJsonAsync<DresseurDto>();
                        player1Pseudo = dresseur?.Pseudo ?? "Joueur 1";
                        Logger.LogInformation($"Player1 (API): {player1Pseudo}");
                    }
                    else
                    {
                        player1Pseudo = "Joueur 1";
                        Logger.LogWarning($"Impossible de charger le pseudo du joueur 1");
                    }
                }
            }

            // Charger le pseudo du joueur 2
            if (!string.IsNullOrEmpty(partie.Dresseur2Id))
            {
                if (partie.Dresseur2Id == currentUserId)
                {
                    player2Pseudo = AuthService.CurrentPseudo ?? "Joueur 2";
                    Logger.LogInformation($"Player2 (Vous): {player2Pseudo}");
                }
                else
                {
                    var response = await Http.GetAsync($"api/dresseurs/{partie.Dresseur2Id}");
                    if (response.IsSuccessStatusCode)
                    {
                        var dresseur = await response.Content.ReadFromJsonAsync<DresseurDto>();
                        player2Pseudo = dresseur?.Pseudo ?? "Joueur 2";
                        Logger.LogInformation($"Player2 (API): {player2Pseudo}");
                    }
                    else
                    {
                        player2Pseudo = "Joueur 2";
                        Logger.LogWarning($"Impossible de charger le pseudo du joueur 2");
                    }
                }
            }
            else
            {
                player2Pseudo = string.Empty;
                Logger.LogInformation("Player2: En attente (Dresseur2Id est vide)");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des pseudos");
        }
    }

    private async Task RefreshGameStatus(bool silent = false)
    {
        if (string.IsNullOrEmpty(currentPartieId)) return;

        if (!silent)
            isLoading = true;
            
        errorMessage = null;
        try
        {
            var response = await Http.GetAsync($"api/partie/{currentPartieId}");
            response.EnsureSuccessStatusCode();
            var oldStatus = partie?.Statut;
            partie = await response.Content.ReadFromJsonAsync<PartieDto>();
            
            Logger.LogInformation($"Rafra√Æchissement: Statut={partie?.Statut}, J1={partie?.Dresseur1Id}, J2={partie?.Dresseur2Id}");
            
            await LoadPlayersInfo();
            
            // Si le statut passe √† "Pr√™t", arr√™ter l'auto-refresh
            if (oldStatus == "EnAttente" && partie?.Statut == "Pr√™t")
            {
                StopAutoRefresh();
                successMessage = "Le joueur 2 a rejoint ! Vous pouvez d√©marrer la partie.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du rafra√Æchissement");
            if (!silent)
                errorMessage = $"Erreur: {ex.Message}";
        }
        finally 
        { 
            if (!silent)
                isLoading = false; 
        }
    }

    private async Task CopySessionCode()
    {
        if (partie?.CodeSession != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", partie.CodeSession);
                successMessage = "Code copi√© dans le presse-papier !";
                await Task.Delay(2000);
                successMessage = null;
                StateHasChanged();
            }
            catch
            {
                // Fallback si clipboard API n'est pas disponible
                successMessage = "Impossible de copier automatiquement. Code : " + partie.CodeSession;
            }
        }
    }

    private void CancelLobby()
    {
        StopAutoRefresh();
        currentPartieId = string.Empty;
        partie = null;
        player1Pseudo = string.Empty;
        player2Pseudo = string.Empty;
        successMessage = null;
        errorMessage = null;
    }

    // DTOs locaux (ou √† partager)
    private class CreateGameRequest { public string DresseurId { get; set; } = string.Empty; }
    private class JoinGameRequest 
    { 
        public string CodeSession { get; set; } = string.Empty;
        public string DresseurId { get; set; } = string.Empty;
    }
    private class StartGameRequest { public string Mode { get; set; } = string.Empty; }
    
    private class PartieDto
    {
        public string? Id { get; set; }
        public string? CodeSession { get; set; }
        public string? Statut { get; set; }  // Correspond √† "Statut" dans le backend
        public string? Dresseur1Id { get; set; }
        public string? Dresseur2Id { get; set; }
    }

    private class DresseurDto
    {
        public string? Id { get; set; }
        public string? Pseudo { get; set; }
    }
}

<style>
    .hero-content { max-width: 900px; margin: 0 auto; padding: 2rem; color: #fff; }
    .hero-title { font-size: 2rem; margin-bottom: 2rem; text-align: center; }
    
    .game-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
    .option-card { background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; transition: transform 0.2s; }
    .option-card:hover { transform: translateY(-4px); border-color: #4ecdc4; }
    .option-card h3 { margin-top: 0; color: #4ecdc4; }
    .card-description { color: #aaa; font-size: 0.9rem; margin-bottom: 1.5rem; }
    .option-card input { padding: 0.75rem; width: 100%; margin-bottom: 1rem; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1rem; }
    .option-card input:focus { outline: none; border-color: #4ecdc4; }
    .option-card button { padding: 0.75rem 1.5rem; background: linear-gradient(45deg, #4ecdc4, #44a3d5); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: transform 0.2s; }
    .option-card button:hover:not(:disabled) { transform: translateY(-2px); }
    .option-card button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .lobby-container { background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .lobby-header { text-align: center; margin-bottom: 2rem; }
    .lobby-header h2 { color: #4ecdc4; margin-bottom: 1rem; }
    
    .session-code-display { display: flex; align-items: center; justify-content: center; gap: 1rem; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; }
    .session-code-display .label { color: #aaa; }
    .session-code-display .code { font-size: 1.5rem; font-weight: bold; color: #4ecdc4; letter-spacing: 2px; }
    .copy-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .copy-btn:hover { background: rgba(78,205,196,0.2); border-color: #4ecdc4; }
    
    .players-status { display: flex; align-items: center; justify-content: center; gap: 2rem; margin: 2rem 0; }
    .player-card { flex: 1; max-width: 250px; background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); text-align: center; position: relative; }
    .player-card.current-player { border-color: #4ecdc4; background: rgba(78,205,196,0.1); }
    .player-icon { font-size: 3rem; margin-bottom: 0.5rem; }
    .player-label { color: #aaa; font-size: 0.9rem; margin-bottom: 0.25rem; }
    .player-name { font-size: 1.2rem; font-weight: bold; color: #fff; }
    .you-badge { position: absolute; top: 0.5rem; right: 0.5rem; background: #4ecdc4; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    
    .vs-divider { font-size: 1.5rem; font-weight: bold; color: #ffa500; }
    
    .lobby-actions { text-align: center; margin-top: 2rem; }
    .ready-message { background: rgba(76,175,80,0.2); color: #4caf50; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .waiting-message { background: rgba(255,165,0,0.2); color: #ffa500; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .waiting-message .hint { margin-top: 0.5rem; font-size: 0.9rem; }
    .status-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #aaa; }
    
    .start-btn, .refresh-btn, .cancel-btn { padding: 0.75rem 2rem; margin: 0.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
    .start-btn { background: linear-gradient(45deg, #4caf50, #45a049); color: white; font-size: 1.1rem; }
    .start-btn:hover:not(:disabled) { transform: translateY(-2px); }
    .refresh-btn { background: rgba(78,205,196,0.2); color: #4ecdc4; border: 2px solid #4ecdc4; }
    .refresh-btn:hover:not(:disabled) { background: rgba(78,205,196,0.3); }
    .cancel-btn { background: rgba(244,67,54,0.2); color: #f44336; border: 2px solid #f44336; }
    .cancel-btn:hover { background: rgba(244,67,54,0.3); }
    .start-btn:disabled, .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .success-message { margin-top: 1rem; padding: 1rem; background: rgba(76,175,80,0.2); color: #4caf50; border-radius: 8px; text-align: center; }
    .text-danger { color: #f44336; padding: 1rem; background: rgba(244,67,54,0.2); border-radius: 8px; text-align: center; }
</style>
